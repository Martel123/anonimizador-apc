‚úÖ PROMPT FINAL (COPIAR Y PEGAR EN REPLIT AGENT)

CONTEXTO REAL (NO INVENTAR NADA NUEVO):
En Render ya funciona subir y anonimizar (DOCX/PDF/TXT/DOC con fallback). Pero perd√≠ mi flujo original de revisi√≥n interactiva (el que sale en el video):

Header + estilo original

‚ÄúRevisi√≥n interactiva‚Äù

Buscador ‚ÄúBuscar en documento‚Äù

Vista previa del documento seleccionable (‚Äúselecciona texto para tokenizar‚Äù)

Lista de entidades detectadas + confirmaciones

Bot√≥n para aplicar cambios y luego pantalla final (descargar documento + reporte)

OBJETIVO:
Dejar el sistema EXACTAMENTE como el que ya constru√≠ antes (UI + flujo completo), pero usando el backend actual que ya corre en Render, sin romper nada.

REGLAS DURAS (OBLIGATORIAS)

NO rehacer dise√±o. NO crear ‚Äúotra‚Äù UI. NO simplificar.

NO crear endpoints nuevos. Usa los endpoints existentes:

POST /anonymizer/process

GET /anonymizer/review/<job_id>

POST /anonymizer/review/<job_id>/apply

(y los endpoints de descarga/resultados que ya existen)

NO tocar render.yaml.

NO romper lo que ya funciona en Render (subida + generaci√≥n de output + descargas).

REUTILIZA el HTML/CSS/JS de mi flujo antiguo (el que est√° en app.py y/o templates) y mu√©velo/con√©ctalo al flujo actual (que est√° en public_app.py).

TAREA A ‚Äî ENCONTRAR MI UI/FLUJO ORIGINAL (NO INVENTAR)

En Replit, en Files, ubica el c√≥digo y templates originales buscando EXACTAMENTE estas frases:

"Revisi√≥n interactiva"

"Modo estricto activado"

"Buscar en documento"

"Vista previa del documento"

"selecciona texto para tokenizar"

üëâ Eso te llevar√° al template/ruta real (probablemente en app.py y uno o m√°s templates en /templates).

IMPORTANTE: NO recrees HTML. COPIA/PEGA el template original tal cual.

TAREA B ‚Äî HACER QUE RENDER USE ESA MISMA UI DE REVISI√ìN

Ahora mismo, en Render, cuando strict_mode=True, me manda a una pantalla ‚Äúplana‚Äù (lista infinita con ‚ÄúConfirmado‚Äù) que NO es la que quiero.

En public_app.py:

Mant√©n el backend actual (validaciones + procesadores por extensi√≥n) porque ya funciona.

Cuando strict_mode=True, el flujo debe ser:

Subida OK ‚Üí detectar entidades ‚Üí guardar job en jobs_store ‚Üí redirect a GET /anonymizer/review/<job_id>

Esa ruta debe renderizar TU TEMPLATE ORIGINAL (el del video), no uno nuevo.

En la ruta GET /anonymizer/review/<job_id>:

Renderiza el mismo template que usa tu versi√≥n antigua.

P√°sale EXACTAMENTE las variables que ese template espera (seg√∫n tu c√≥digo viejo).

Si tu template viejo espera algo como confirmed, needs_review, text_preview, job_id, filename, has_warning, etc., entonces adapta el jobs_store para que tenga esos campos con ese mismo nombre.

TAREA C ‚Äî NORMALIZAR ENTIDADES (SIN ROMPER LA UI ORIGINAL)

Tu detector/robust puede devolver entidades como dict u objetos. Para que tu UI original no falle:

Crea/usa una funci√≥n entity_to_dict() y normalize_entities() (si ya existen, CONS√âRVALAS) para asegurar que cada entidad tenga SIEMPRE estas keys:

{
  "type": "...",
  "value": "...",
  "text": "...",
  "start": int,
  "end": int,
  "confidence": float,
  "source": "..."
}


Pero ojo: esto es SOLO para compatibilidad. No cambies el comportamiento del detector, solo su forma final.

TAREA D ‚Äî ‚ÄúSELECCIONAR TEXTO PARA TOKENIZAR‚Äù DEBE VOLVER A FUNCIONAR

Tu UI original permit√≠a seleccionar texto en la vista previa y tokenizarlo.

Eso depende de 2 cosas:

El template original debe incluir el JS que:

captura selecci√≥n de texto

crea entidades manuales (custom)

las agrega a la lista

actualiza preview en vivo (si as√≠ estaba)

POST /anonymizer/review/<job_id>/apply debe:

recibir las entidades finales (confirmed + manuales + lo que el usuario marc√≥)

generar el output final usando el procesador correspondiente

devolver JSON con redirect (o la respuesta exacta que tu template original espera)

‚úÖ Si tu apply viejo devolv√≠a:

{"ok": true, "redirect": "/anonymizer/process?..."}


entonces conserva ese formato.

REGLA: No inventes estructura nueva. Respeta la que ya ten√≠as.

TAREA E ‚Äî PANTALLA FINAL EXACTA (LA QUE YA TEN√çAS)

Cuando terminas (sin estricto o despu√©s de aplicar revisi√≥n) debe mostrar la pantalla final con:

‚ÄúDocumento anonimizado‚Äù

contador de reemplazos

bot√≥n descargar documento

bot√≥n descargar reporte (JSON)

resumen por tipo (DNI, PERSONA, DIRECCION, etc.)

tabla de reemplazos

üëâ Esa pantalla ya existe en tu proyecto (se ve en tus capturas).
Si en Render se ve distinta, entonces debes hacer que use el template viejo, no uno nuevo.

TAREA F ‚Äî NO CAMBIAR EL FORM DE SUBIDA

Asegura que el input siga siendo (ya est√° bien):

<input type="file" name="file" id="file-input" accept=".doc,.docx,.pdf,.txt" class="hidden" required>


Y que el logo no cambie:
/static/images/logo_apc_juridica.png

ENTREGA OBLIGATORIA (AL FINAL)

Dime EXACTAMENTE qu√© archivos modificaste.

Mu√©strame un resumen tipo diff (qu√© cambi√≥ en cada archivo).

Confirma con checklist:

 strict_mode ON ‚Üí va a /anonymizer/review/<job_id> con mi UI original (video)

 seleccionar texto ‚Üí crea entidad manual ‚Üí se refleja en lista

 apply ‚Üí genera output ‚Üí manda a pantalla final original

 strict_mode OFF ‚Üí va directo a pantalla final original

 Render funciona igual que Replit

NOTA FINAL (CR√çTICA)

NO quiero una UI nueva ni ‚Äúmejorada‚Äù.
Quiero que encuentres mi sistema original (app.py/templates) y lo conectes al flujo actual (public_app.py/jobs_store/detecci√≥n/procesamiento) para que Render muestre EXACTAMENTE lo mismo que yo ya ten√≠a.