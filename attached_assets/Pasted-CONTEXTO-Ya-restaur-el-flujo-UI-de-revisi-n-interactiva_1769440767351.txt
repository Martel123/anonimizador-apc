CONTEXTO:
Ya restaur√© el flujo UI de revisi√≥n interactiva (buscar, preview seleccionable, marcar manualmente, etc.), pero ahora NO anonimiza (0 reemplazos / no tokeniza realmente).
ANTES yo ya hab√≠a logrado una anonimizaci√≥n casi al 100% con un motor avanzado (capas de detecci√≥n, reglas, etc.). Quiero exactamente ese motor, NO una versi√≥n simplificada.

OBJETIVO

Mantener mi dise√±o y flujo completo (review interactivo + apply + pantalla final con conteos y reportes).

Enchufar mi motor avanzado real de anonimizaci√≥n (detecci√≥n por capas + reemplazo real en DOCX/PDF/TXT) para que:

detecte bien (alto recall)

reemplace bien (alto replace)

y el modo estricto permita a√±adir manuales y aplicar.

REGLAS DURAS

NO crear endpoints nuevos

NO tocar render.yaml

NO rehacer UI / NO cambiar templates (solo si es estrictamente necesario para variables)

NO inventar detectores nuevos

NO degradar el motor: hay que usar el que YA EXISTE en el repo (lo que yo ya toqu√© y mejor√©).

TAREA 1 ‚Äî IDENTIFICAR ‚ÄúMI MOTOR AVANZADO‚Äù EN EL REPO (OBLIGATORIO)

Busca en el c√≥digo del repo (Files) por estas palabras clave y ubica los m√≥dulos reales del motor:

DetectorCapas

capas

rules

regex

process_document_robust

anonymizer_robust

detect_all_pii

anonymize_docx_complete

anonymize_pdf

entities_replaced

mapping

strict_mode

Resultado esperado: identificar cu√°l era el ‚Äúpipeline‚Äù original:

funci√≥n principal que detecta (devuelve entidades)

funci√≥n principal que aplica/reemplaza (genera output + reporte)

y c√≥mo calculaba ‚Äúreemplazos realizados‚Äù.

IMPORTANTE: si hay dos pipelines (uno simple y uno robust), usa el robust/avanzado.

TAREA 2 ‚Äî CORREGIR EL FLUJO ACTUAL PARA QUE USE EL MOTOR AVANZADO (SIN CAMBIAR UI)

En public_app.py, revisa los handlers:

A) POST /anonymizer/process

Debe hacer esto (sin romper lo que ya funciona):

Guardar archivo

Validar formato (ya est√° ok)

DETECTAR usando el motor avanzado real (NO detector simplificado)

Normalizar entidades a dict est√°ndar (si ya existe normalize_entities, √∫salo)

Guardar en jobs_store[job_id] TODO lo que el template necesita:

confirmed, needs_review, text_preview (o como se llame en tu UI)

filename, ext, file_size, input_path

strict_mode, generate_mapping

Si strict_mode=True ‚Üí redirect a /anonymizer/review/<job_id>

Si strict_mode=False ‚Üí APLICAR reemplazo REAL usando el motor avanzado y redirigir a pantalla final.

üî¥ PROHIBIDO: que strict_mode=False use un ‚Äúanonymize_docx_simple‚Äù o algo b√°sico si tu motor robust existe.

B) GET /anonymizer/review/<job_id>

No cambies UI. Solo aseg√∫rate de pasar las variables correctas.

C) POST /anonymizer/review/<job_id>/apply

Este es el punto cr√≠tico: aqu√≠ debe aplicar el reemplazo REAL usando:

entidades confirmadas + manuales seleccionadas por el usuario

y debe producir:

output final (docx/pdf/txt)

reporte (json)

conteo de reemplazos

OBLIGATORIO: este apply debe llamar a la MISMA funci√≥n robusta que antes te daba casi 100%.
Si antes el reemplazo lo hac√≠a anonymizer_robust o processor_docx.anonymize_docx_complete con un set de entidades espec√≠fico, respeta ese formato.

TAREA 3 ‚Äî ARREGLAR LA CAUSA M√ÅS COM√öN DE ‚Äú0 REEMPLAZOS‚Äù

La UI muestra entidades, pero el motor no reemplaza por 1 de estas razones (tienes que diagnosticar cu√°l aplica):

Las entidades no est√°n en el formato exacto que espera el reemplazo (ej: espera value pero le pasas text, o espera start/end pero llegan vac√≠os).

El motor DOCX reemplaza por coincidencia de texto (value) pero est√°s mandando tokens con llaves o texto distinto.

El review UI est√° mandando entidades, pero apply las est√° leyendo con otra key y termina con final_entities=[].

Se detecta sobre text_preview (texto plano), pero el reemplazo espera otro tipo de representaci√≥n.

‚úÖ Soluci√≥n obligatoria:

Antes de reemplazar, crea una funci√≥n entities_for_apply(final_entities) que convierta SIEMPRE a lo que el motor espera (sin cambiar motor).

Y loggea:

APPLY_ENTITIES_COUNT

APPLY_ENTITY_SAMPLE (solo keys, sin datos sensibles)

REPLACED_COUNT real

TAREA 4 ‚Äî MANTENER COMPATIBILIDAD CON RENDER

Tu motor robust debe correr igual en Render. Si el robust depende de algo que Render no tiene, haz fallback SOLO en ese caso, pero sin romper:

Si falta dependencia: mensaje claro + logs

No cambies endpoints

No cambies UI

LOGS OBLIGATORIOS (para confirmar que ya reemplaza)

Agrega logs en public_app.py:

DETECT_OK | confirmed=X | needs_review=Y

STRICT_MODE | redirect=/anonymizer/review/<job_id>

APPLY_START | entities=N | ext=...

APPLY_OK | replaced=K | output=...

APPLY_FAIL | traceback=...

ENTREGA OBLIGATORIA

Al final dime:

Qu√© archivos tocaste (idealmente solo public_app.py, y si tocaste algo m√°s, justifica).

Qu√© funci√≥n exacta del motor avanzado qued√≥ conectada para:

detectar

reemplazar

C√≥mo probar:

strict ON: subo docx ‚Üí review ‚Üí marco manual ‚Üí apply ‚Üí output con reemplazos > 0

strict OFF: subo docx ‚Üí output directo con reemplazos > 0

RESTRICCI√ìN FINAL

NO quiero una ‚Äúimplementaci√≥n nueva‚Äù.
Quiero que uses y conectes lo que YA existe en el repo: todas mis capas, reglas, mejoras, prompts, etc.