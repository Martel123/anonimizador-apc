PROMPT â€” ImplementaciÃ³n de Google Authenticator (2FA)

Implementa autenticaciÃ³n en dos factores (2FA) usando TOTP compatible con Google Authenticator / Authy / Microsoft Authenticator.

1ï¸âƒ£ Cambios en base de datos

Agregar al modelo de usuario los siguientes campos:

twofa_enabled (boolean)

twofa_secret_encrypted (string, encriptado)

twofa_backup_codes_hashed (array de strings hasheados)

twofa_last_verified_at (datetime)

twofa_required (boolean, para forzar 2FA por rol o empresa)

2ï¸âƒ£ ActivaciÃ³n de 2FA (Setup)

Crear un flujo â€œActivar Google Authenticatorâ€:

Generar un secreto TOTP Ãºnico por usuario.

Mostrar un QR Code (otpauth://) para escanear.

Pedir al usuario ingresar el cÃ³digo de 6 dÃ­gitos.

Si el cÃ³digo es vÃ¡lido:

Guardar el secreto encriptado.

Marcar twofa_enabled = true.

Generar 8â€“10 cÃ³digos de recuperaciÃ³n de un solo uso:

Mostrar una sola vez.

Guardarlos hasheados en BD.

3ï¸âƒ£ Login con 2FA

Si el usuario tiene twofa_enabled = true, despuÃ©s del email/password:

Solicitar cÃ³digo TOTP de 6 dÃ­gitos o un backup code.

Validar el cÃ³digo con tolerancia de tiempo.

Invalidar backup codes cuando se usen.

4ï¸âƒ£ PolÃ­ticas por rol (OBLIGATORIO)

super_admin â†’ 2FA obligatorio.

admin â†’ 2FA obligatorio.

coordinador / usuario â†’ opcional.

Preparar lÃ³gica para que una empresa pueda forzar 2FA a todos sus usuarios en el futuro.

5ï¸âƒ£ RecuperaciÃ³n / Reset de 2FA

Un usuario NO puede quitar su 2FA sin verificaciÃ³n.

Admin puede resetear 2FA de usuarios de su empresa.

Super_admin puede resetear 2FA de cualquier usuario.

Registrar auditorÃ­a del reset.

6ï¸âƒ£ Seguridad adicional

Encriptar el secreto TOTP en BD.

Hashear backup codes.

Rate limit para intentos de cÃ³digo.

Registrar intentos fallidos.

7ï¸âƒ£ UI

Pantalla â€œSeguridadâ€:

Estado de 2FA (activo/inactivo)

BotÃ³n â€œActivar / Desactivarâ€

BotÃ³n â€œRegenerar cÃ³digos de recuperaciÃ³nâ€

Antes de programar, describe brevemente:

Endpoints necesarios

Flujo de login

Manejo de errores

ğŸ§  AHORA: Â¿CÃ“MO FUNCIONA ESTO EN LA VIDA REAL? (EJEMPLO)

Imagina este escenario real en tu plataforma.

ğŸ‘¤ PERSONA: un abogado (usuario normal)
ğŸ“Œ Paso 1: entra a su perfil

Va a ConfiguraciÃ³n â†’ Seguridad

Ve un botÃ³n: â€œActivar Google Authenticatorâ€

ğŸ“Œ Paso 2: activa el Authenticator

La plataforma le muestra un QR

Abre Google Authenticator en su celular

Escanea el QR

La app empieza a generar cÃ³digos tipo:

482 193


Ã‰l escribe ese cÃ³digo en la web

La plataforma valida â†’ âœ… correcto

ğŸ‘‰ En este momento:

el secreto queda guardado

2FA queda activo

ğŸ“Œ Paso 3: descarga cÃ³digos de recuperaciÃ³n

La plataforma le muestra algo como:

CÃ³digos de recuperaciÃ³n (guÃ¡rdalos):
- 9F2K-LQ8A
- MZ3P-71QX
- 8RPL-22WA
...


âš ï¸ Se le dice:

â€œGuÃ¡rdalos en un lugar seguro. Cada uno se puede usar una sola vez.â€

ğŸ”‘ LOGIN NORMAL (DÃA A DÃA)
Antes:

Email + contraseÃ±a â†’ entra

Ahora:

Email + contraseÃ±a

Pantalla extra:

â€œIngresa el cÃ³digo de Google Authenticatorâ€

Abre su celular

Escribe el cÃ³digo de 6 dÃ­gitos

Entra âœ…

â±ï¸ Esto toma 5 segundos.

ğŸš¨ Â¿QUÃ‰ PASA SI PIERDE EL CELULAR?
Caso A: tiene backup codes

Usa uno

Entra

Puede regenerar Authenticator

Caso B: no tiene backup codes

Contacta al admin de su estudio

El admin hace â€œResetear 2FAâ€

El usuario vuelve a activar

Caso C: es el admin

El super_admin (tÃº) hace el reset

ğŸ‘‘ TU CASO (super_admin)

TÃº SIEMPRE tendrÃ¡s 2FA obligatorio

Sin Authenticator:

no puedes entrar

Esto protege:

todas las empresas

todos los documentos

todo el sistema