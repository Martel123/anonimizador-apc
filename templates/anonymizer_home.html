{% extends "base_anonymizer.html" %}

{% block title %}Anonimizador Legal - Protege tus documentos{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
    <div class="text-center mb-8">
        <h2 class="text-3xl font-semibold text-gray-800 mb-2">Anonimiza tus documentos legales</h2>
        <p class="text-gray-600 max-w-2xl mx-auto">
            Sube un documento DOCX o PDF y nuestro sistema identificará automáticamente 
            datos personales usando IA y reglas especializadas para documentos legales peruanos.
        </p>
    </div>

    <div class="bg-white rounded-2xl shadow-lg border border-gray-100 overflow-hidden">
        <div class="p-8">
            <form id="upload-form" action="{{ url_for('anonymizer_process') }}" method="POST" enctype="multipart/form-data">
                <div id="drop-zone" class="drop-zone rounded-xl p-12 text-center cursor-pointer hover:border-indigo-400">
                    <input type="file" name="documento" id="file-input" accept=".docx,.pdf" class="hidden" required>
                    
                    <div id="upload-prompt" class="space-y-4">
                        <div class="w-20 h-20 mx-auto bg-indigo-50 rounded-full flex items-center justify-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-indigo-500"></i>
                        </div>
                        <div>
                            <p class="text-lg font-medium text-gray-700">Arrastra tu archivo aquí</p>
                            <p class="text-gray-500">o haz clic para seleccionar</p>
                        </div>
                        <div class="flex items-center justify-center space-x-4 text-sm text-gray-400">
                            <span class="flex items-center"><i class="far fa-file-word text-blue-500 mr-1"></i> DOCX</span>
                            <span class="flex items-center"><i class="far fa-file-pdf text-red-500 mr-1"></i> PDF</span>
                        </div>
                        <p class="text-xs text-gray-400">Máximo 10 MB | PDF hasta 50 páginas</p>
                    </div>

                    <div id="file-selected" class="hidden space-y-4">
                        <div class="w-16 h-16 mx-auto bg-green-50 rounded-full flex items-center justify-center">
                            <i class="fas fa-file-check text-3xl text-green-500"></i>
                        </div>
                        <div>
                            <p id="selected-filename" class="text-lg font-medium text-gray-700"></p>
                            <p id="selected-filesize" class="text-sm text-gray-500"></p>
                        </div>
                        <button type="button" id="change-file" class="text-indigo-600 hover:text-indigo-700 text-sm font-medium">
                            <i class="fas fa-exchange-alt mr-1"></i> Cambiar archivo
                        </button>
                    </div>
                </div>

                <div class="mt-6 p-6 bg-gray-50 rounded-xl space-y-6">
                    <h3 class="font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-cog text-indigo-500 mr-2"></i>
                        Opciones de anonimización
                    </h3>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-3">Modo de sustitución</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                            <label class="mode-option relative flex cursor-pointer rounded-lg border-2 bg-white p-4 hover:border-indigo-300 transition-all">
                                <input type="radio" name="modo" value="tokens" class="sr-only" checked>
                                <div class="flex-1">
                                    <span class="block text-sm font-semibold text-gray-900">Tokens</span>
                                    <span class="mt-1 block text-xs text-gray-500">{{PERSONA_1}}, {{DNI_1}}</span>
                                </div>
                                <i class="fas fa-check-circle text-indigo-500 hidden mode-check"></i>
                            </label>
                            
                            <label class="mode-option relative flex cursor-pointer rounded-lg border-2 bg-white p-4 hover:border-indigo-300 transition-all">
                                <input type="radio" name="modo" value="asterisks" class="sr-only">
                                <div class="flex-1">
                                    <span class="block text-sm font-semibold text-gray-900">Asteriscos</span>
                                    <span class="mt-1 block text-xs text-gray-500">********, ****@****.***</span>
                                </div>
                                <i class="fas fa-check-circle text-indigo-500 hidden mode-check"></i>
                            </label>
                            
                            <label class="mode-option relative flex cursor-pointer rounded-lg border-2 bg-white p-4 hover:border-indigo-300 transition-all">
                                <input type="radio" name="modo" value="synthetic" class="sr-only">
                                <div class="flex-1">
                                    <span class="block text-sm font-semibold text-gray-900">Sintético</span>
                                    <span class="mt-1 block text-xs text-gray-500">Juan Pérez, 12345678</span>
                                </div>
                                <i class="fas fa-check-circle text-indigo-500 hidden mode-check"></i>
                            </label>
                        </div>
                    </div>

                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 pt-4 border-t border-gray-200">
                        <div class="flex items-center justify-between sm:justify-start sm:space-x-4">
                            <div>
                                <label for="strict_mode" class="text-sm font-medium text-gray-700">Modo estricto</label>
                                <p class="text-xs text-gray-500">Revisión manual de nombres dudosos</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="strict_mode" id="strict_mode" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between sm:justify-start sm:space-x-4">
                            <div>
                                <label for="generate_mapping" class="text-sm font-medium text-gray-700">Diccionario CSV</label>
                                <p class="text-xs text-gray-500">Exportar tabla de mapeo</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="generate_mapping" id="generate_mapping" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-indigo-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="processing-section" class="hidden mt-6">
                    <div class="bg-indigo-50 rounded-lg p-6 text-center">
                        <div class="flex items-center justify-center space-x-3 mb-4">
                            <div class="w-6 h-6 border-2 border-indigo-500 border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-indigo-700 font-medium">Procesando documento...</span>
                        </div>
                        <div class="w-full bg-indigo-200 rounded-full h-2">
                            <div id="progress-bar" class="progress-bar bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-indigo-600 mt-2">Detectando datos personales con IA y reglas</p>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="mt-6 w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-medium rounded-xl transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-shield-alt mr-2"></i>
                    Anonimizar documento
                </button>
            </form>
        </div>
    </div>

    <div class="grid md:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl p-6 border border-gray-100 shadow-sm">
            <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center mb-4">
                <i class="fas fa-brain text-blue-500 text-xl"></i>
            </div>
            <h3 class="font-medium text-gray-800 mb-2">Detección híbrida</h3>
            <p class="text-sm text-gray-500">Combina IA (spaCy NER) con reglas especializadas para documentos legales peruanos.</p>
        </div>
        <div class="bg-white rounded-xl p-6 border border-gray-100 shadow-sm">
            <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center mb-4">
                <i class="fas fa-user-check text-green-500 text-xl"></i>
            </div>
            <h3 class="font-medium text-gray-800 mb-2">Modo estricto</h3>
            <p class="text-sm text-gray-500">Revisa manualmente entidades dudosas antes de finalizar la anonimización.</p>
        </div>
        <div class="bg-white rounded-xl p-6 border border-gray-100 shadow-sm">
            <div class="w-12 h-12 bg-purple-50 rounded-lg flex items-center justify-center mb-4">
                <i class="fas fa-random text-purple-500 text-xl"></i>
            </div>
            <h3 class="font-medium text-gray-800 mb-2">3 modos de sustitución</h3>
            <p class="text-sm text-gray-500">Tokens, asteriscos o datos sintéticos realistas para cada caso de uso.</p>
        </div>
    </div>

    <div class="bg-white rounded-xl p-6 border border-gray-100 shadow-sm">
        <h3 class="font-medium text-gray-800 mb-4 flex items-center">
            <i class="fas fa-tags text-indigo-500 mr-2"></i>
            Tipos de datos detectados
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
            <div class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded-lg">
                <span class="px-2 py-0.5 bg-red-100 text-red-600 rounded font-mono text-xs">DNI</span>
                <span class="text-gray-600">8 dígitos</span>
            </div>
            <div class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded-lg">
                <span class="px-2 py-0.5 bg-orange-100 text-orange-600 rounded font-mono text-xs">RUC</span>
                <span class="text-gray-600">11 dígitos</span>
            </div>
            <div class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded-lg">
                <span class="px-2 py-0.5 bg-blue-100 text-blue-600 rounded font-mono text-xs">EMAIL</span>
                <span class="text-gray-600">Correos</span>
            </div>
            <div class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded-lg">
                <span class="px-2 py-0.5 bg-green-100 text-green-600 rounded font-mono text-xs">TEL</span>
                <span class="text-gray-600">Teléfonos</span>
            </div>
            <div class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded-lg">
                <span class="px-2 py-0.5 bg-purple-100 text-purple-600 rounded font-mono text-xs">PERSONA</span>
                <span class="text-gray-600">Nombres</span>
            </div>
            <div class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded-lg">
                <span class="px-2 py-0.5 bg-yellow-100 text-yellow-600 rounded font-mono text-xs">DIR</span>
                <span class="text-gray-600">Direcciones</span>
            </div>
            <div class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded-lg">
                <span class="px-2 py-0.5 bg-pink-100 text-pink-600 rounded font-mono text-xs">EXP</span>
                <span class="text-gray-600">Expedientes</span>
            </div>
            <div class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded-lg">
                <span class="px-2 py-0.5 bg-cyan-100 text-cyan-600 rounded font-mono text-xs">CAS</span>
                <span class="text-gray-600">Casillas</span>
            </div>
            <div class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded-lg">
                <span class="px-2 py-0.5 bg-indigo-100 text-indigo-600 rounded font-mono text-xs">JUZ</span>
                <span class="text-gray-600">Juzgados</span>
            </div>
            <div class="flex items-center space-x-2 text-sm p-2 bg-gray-50 rounded-lg">
                <span class="px-2 py-0.5 bg-teal-100 text-teal-600 rounded font-mono text-xs">NER</span>
                <span class="text-gray-600">IA spaCy</span>
            </div>
        </div>
    </div>

    <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
        <div class="flex items-start">
            <i class="fas fa-lightbulb text-amber-500 mt-1 mr-3"></i>
            <div class="text-sm text-amber-700">
                <p class="font-medium mb-1">Placeholders preservados</p>
                <p>Los marcadores existentes como <code class="bg-amber-100 px-1 rounded">{<!-- -->{FALTA_DATO}}</code> se mantienen sin modificar.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadPrompt = document.getElementById('upload-prompt');
    const fileSelected = document.getElementById('file-selected');
    const selectedFilename = document.getElementById('selected-filename');
    const selectedFilesize = document.getElementById('selected-filesize');
    const changeFileBtn = document.getElementById('change-file');
    const submitBtn = document.getElementById('submit-btn');
    const uploadForm = document.getElementById('upload-form');
    const processingSection = document.getElementById('processing-section');
    const progressBar = document.getElementById('progress-bar');

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function validateFile(file) {
        const maxSize = 10 * 1024 * 1024;
        const allowedTypes = ['.docx', '.pdf'];
        const extension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedTypes.includes(extension)) {
            alert('Formato no permitido. Solo se aceptan archivos DOCX y PDF.');
            return false;
        }
        if (file.size > maxSize) {
            alert('El archivo excede el tamaño máximo de 10 MB.');
            return false;
        }
        return true;
    }

    function showFileSelected(file) {
        if (!validateFile(file)) {
            fileInput.value = '';
            return;
        }
        uploadPrompt.classList.add('hidden');
        fileSelected.classList.remove('hidden');
        selectedFilename.textContent = file.name;
        selectedFilesize.textContent = formatFileSize(file.size);
        submitBtn.disabled = false;
    }

    function resetForm() {
        fileInput.value = '';
        uploadPrompt.classList.remove('hidden');
        fileSelected.classList.add('hidden');
        submitBtn.disabled = true;
    }

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            showFileSelected(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            showFileSelected(e.target.files[0]);
        }
    });

    changeFileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        resetForm();
    });

    const modeOptions = document.querySelectorAll('.mode-option');
    function updateModeSelection() {
        modeOptions.forEach(option => {
            const input = option.querySelector('input[type="radio"]');
            const check = option.querySelector('.mode-check');
            if (input.checked) {
                option.classList.add('border-indigo-500', 'bg-indigo-50');
                check.classList.remove('hidden');
            } else {
                option.classList.remove('border-indigo-500', 'bg-indigo-50');
                check.classList.add('hidden');
            }
        });
    }
    
    modeOptions.forEach(option => {
        option.addEventListener('click', () => {
            option.querySelector('input[type="radio"]').checked = true;
            updateModeSelection();
        });
    });
    updateModeSelection();

    uploadForm.addEventListener('submit', function(e) {
        submitBtn.disabled = true;
        dropZone.style.display = 'none';
        processingSection.classList.remove('hidden');
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 300);
        
        setTimeout(() => clearInterval(interval), 30000);
    });
});
</script>
{% endblock %}
