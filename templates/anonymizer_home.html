{% extends "base_anonymizer.html" %}

{% block title %}Anonimizador Legal - APC Jurídica{% endblock %}

{% block content %}
<div class="space-y-6 fade-in">
    <div class="text-center mb-8">
        <h2 class="text-2xl font-semibold text-apc-black mb-2">Anonimiza tus documentos legales</h2>
        <p class="text-apc-gray-text max-w-2xl mx-auto">
            Sube un documento DOCX o PDF y nuestro sistema identificará automáticamente 
            datos personales usando IA y reglas especializadas para documentos legales peruanos.
        </p>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-apc-gray-border overflow-hidden">
        <div class="p-8">
            <form id="upload-form" action="{{ url_for('anonymizer.anonymizer_process') }}" method="POST" enctype="multipart/form-data">
                <div id="drop-zone" class="drop-zone rounded-xl p-12 text-center cursor-pointer">
                    <input type="file" name="documento" id="file-input" accept=".docx,.pdf" class="hidden" required>
                    
                    <div id="upload-prompt" class="space-y-4">
                        <div class="w-20 h-20 mx-auto bg-red-50 rounded-full flex items-center justify-center">
                            <i class="fas fa-cloud-upload-alt text-4xl text-apc-red"></i>
                        </div>
                        <div>
                            <p class="text-lg font-medium text-apc-black-secondary">Arrastra tu archivo aquí</p>
                            <p class="text-apc-gray-text">o haz clic para seleccionar</p>
                        </div>
                        <div class="flex items-center justify-center space-x-4 text-sm text-apc-gray-text">
                            <span class="flex items-center"><i class="far fa-file-word text-blue-600 mr-1"></i> DOCX</span>
                            <span class="flex items-center"><i class="far fa-file-pdf text-apc-red mr-1"></i> PDF</span>
                        </div>
                        <p class="text-xs text-apc-gray-text">Máximo 10 MB | PDF hasta 50 páginas</p>
                    </div>

                    <div id="file-selected" class="hidden space-y-4">
                        <div class="w-16 h-16 mx-auto bg-green-50 rounded-full flex items-center justify-center">
                            <i class="fas fa-file-check text-3xl text-green-600"></i>
                        </div>
                        <div>
                            <p id="selected-filename" class="text-lg font-medium text-apc-black-secondary"></p>
                            <p id="selected-filesize" class="text-sm text-apc-gray-text"></p>
                        </div>
                        <button type="button" id="change-file" class="text-apc-red hover:text-apc-red-dark text-sm font-medium">
                            <i class="fas fa-exchange-alt mr-1"></i> Cambiar archivo
                        </button>
                    </div>
                </div>

                <div class="mt-6 p-6 bg-apc-gray-bg rounded-xl space-y-6">
                    <h3 class="font-medium text-apc-black-secondary flex items-center">
                        <i class="fas fa-cog text-apc-gray-text mr-2"></i>
                        Opciones de anonimización
                    </h3>
                    
                    <input type="hidden" name="modo" value="tokens">

                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                        <div class="flex items-center justify-between sm:justify-start sm:space-x-4">
                            <div>
                                <label for="strict_mode" class="text-sm font-medium text-apc-black-secondary">Modo estricto</label>
                                <p class="text-xs text-apc-gray-text">Revisión manual de nombres dudosos</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="strict_mode" id="strict_mode" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-apc-gray-border peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-apc-red"></div>
                            </label>
                        </div>
                        
                        <div class="flex items-center justify-between sm:justify-start sm:space-x-4">
                            <div>
                                <label for="generate_mapping" class="text-sm font-medium text-apc-black-secondary">Diccionario CSV</label>
                                <p class="text-xs text-apc-gray-text">Exportar tabla de mapeo</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" name="generate_mapping" id="generate_mapping" class="sr-only peer">
                                <div class="w-11 h-6 bg-apc-gray-border peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-red-100 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-apc-red"></div>
                            </label>
                        </div>
                    </div>
                </div>

                <div id="processing-section" class="hidden mt-6">
                    <div class="bg-red-50 rounded-xl p-6 text-center border border-red-100">
                        <div class="flex items-center justify-center space-x-3 mb-4">
                            <div class="w-6 h-6 border-2 border-apc-red border-t-transparent rounded-full animate-spin"></div>
                            <span class="text-apc-red font-medium">Procesando documento...</span>
                        </div>
                        <div class="w-full bg-red-100 rounded-full h-2">
                            <div id="progress-bar" class="progress-bar bg-apc-red h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <p class="text-sm text-apc-red-soft mt-2">Detectando datos personales con IA y reglas</p>
                    </div>
                </div>

                <button type="submit" id="submit-btn" class="mt-6 w-full py-4 btn-primary font-medium rounded-xl transition-all flex items-center justify-center disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    <i class="fas fa-shield-alt mr-2"></i>
                    Anonimizar documento
                </button>
            </form>
        </div>
    </div>

    <div class="grid md:grid-cols-3 gap-6">
        <div class="bg-white rounded-xl p-6 border border-apc-gray-border shadow-sm">
            <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center mb-4">
                <i class="fas fa-brain text-apc-red text-xl"></i>
            </div>
            <h3 class="font-medium text-apc-black-secondary mb-2">Detección híbrida</h3>
            <p class="text-sm text-apc-gray-text">Combina IA (spaCy NER) con reglas especializadas para documentos legales peruanos.</p>
        </div>
        <div class="bg-white rounded-xl p-6 border border-apc-gray-border shadow-sm">
            <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center mb-4">
                <i class="fas fa-user-check text-apc-red text-xl"></i>
            </div>
            <h3 class="font-medium text-apc-black-secondary mb-2">Modo estricto</h3>
            <p class="text-sm text-apc-gray-text">Revisa manualmente entidades dudosas antes de finalizar la anonimización.</p>
        </div>
        <div class="bg-white rounded-xl p-6 border border-apc-gray-border shadow-sm">
            <div class="w-12 h-12 bg-red-50 rounded-xl flex items-center justify-center mb-4">
                <i class="fas fa-code text-apc-red text-xl"></i>
            </div>
            <h3 class="font-medium text-apc-black-secondary mb-2">Tokens determinísticos</h3>
            <p class="text-sm text-apc-gray-text">Reemplazo preciso con tokens como {{PERSONA_1}}, {{DNI_1}} para trazabilidad.</p>
        </div>
    </div>

    <div class="bg-white rounded-xl p-6 border border-apc-gray-border shadow-sm">
        <h3 class="font-medium text-gray-800 mb-4 flex items-center">
            <i class="fas fa-tags text-apc-gray-text mr-2"></i>
            Tipos de datos detectados
        </h3>
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3">
            <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2.5">
                <span class="px-2 py-0.5 bg-red-100 text-red-600 rounded text-xs font-semibold">DNI</span>
                <span class="text-sm text-gray-600">8 dígitos</span>
            </div>
            <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2.5">
                <span class="px-2 py-0.5 bg-emerald-100 text-emerald-600 rounded text-xs font-semibold">RUC</span>
                <span class="text-sm text-gray-600">11 dígitos</span>
            </div>
            <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2.5">
                <span class="px-2 py-0.5 bg-blue-100 text-blue-600 rounded text-xs font-semibold">EMAIL</span>
                <span class="text-sm text-gray-600">Correos</span>
            </div>
            <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2.5">
                <span class="px-2 py-0.5 bg-cyan-100 text-cyan-600 rounded text-xs font-semibold">TEL</span>
                <span class="text-sm text-gray-600">Teléfonos</span>
            </div>
            <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2.5">
                <span class="px-2 py-0.5 bg-purple-100 text-purple-600 rounded text-xs font-semibold">PERSONA</span>
                <span class="text-sm text-gray-600">Nombres</span>
            </div>
            <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2.5">
                <span class="px-2 py-0.5 bg-gray-200 text-gray-600 rounded text-xs font-semibold">DIR</span>
                <span class="text-sm text-gray-600">Direcciones</span>
            </div>
            <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2.5">
                <span class="px-2 py-0.5 bg-lime-100 text-lime-600 rounded text-xs font-semibold">EXP</span>
                <span class="text-sm text-gray-600">Expedientes</span>
            </div>
            <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2.5">
                <span class="px-2 py-0.5 bg-teal-100 text-teal-600 rounded text-xs font-semibold">CAS</span>
                <span class="text-sm text-gray-600">Casillas</span>
            </div>
            <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2.5">
                <span class="px-2 py-0.5 bg-slate-200 text-slate-600 rounded text-xs font-semibold">JUZ</span>
                <span class="text-sm text-gray-600">Juzgados</span>
            </div>
            <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2.5">
                <span class="px-2 py-0.5 bg-yellow-100 text-yellow-600 rounded text-xs font-semibold">CUENTA</span>
                <span class="text-sm text-gray-600">Bancarias</span>
            </div>
        </div>
    </div>

    <div class="bg-amber-50 rounded-xl p-4 border border-amber-200">
        <div class="flex items-start">
            <i class="fas fa-lightbulb text-amber-600 mt-1 mr-3"></i>
            <div class="text-sm text-amber-700">
                <p class="font-medium mb-1">Placeholders preservados</p>
                <p>Los marcadores existentes como <code class="bg-amber-100 px-1 rounded">{<!-- -->{FALTA_DATO}}</code> se mantienen sin modificar.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('file-input');
    const uploadPrompt = document.getElementById('upload-prompt');
    const fileSelected = document.getElementById('file-selected');
    const selectedFilename = document.getElementById('selected-filename');
    const selectedFilesize = document.getElementById('selected-filesize');
    const changeFileBtn = document.getElementById('change-file');
    const submitBtn = document.getElementById('submit-btn');
    const uploadForm = document.getElementById('upload-form');
    const processingSection = document.getElementById('processing-section');
    const progressBar = document.getElementById('progress-bar');

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
    }

    function validateFile(file) {
        const maxSize = 10 * 1024 * 1024;
        const allowedTypes = ['.docx', '.pdf'];
        const extension = '.' + file.name.split('.').pop().toLowerCase();
        
        if (!allowedTypes.includes(extension)) {
            alert('Formato no permitido. Solo se aceptan archivos DOCX y PDF.');
            return false;
        }
        if (file.size > maxSize) {
            alert('El archivo excede el tamaño máximo de 10 MB.');
            return false;
        }
        return true;
    }

    function showFileSelected(file) {
        if (!validateFile(file)) {
            fileInput.value = '';
            return;
        }
        uploadPrompt.classList.add('hidden');
        fileSelected.classList.remove('hidden');
        selectedFilename.textContent = file.name;
        selectedFilesize.textContent = formatFileSize(file.size);
        submitBtn.disabled = false;
    }

    function resetForm() {
        fileInput.value = '';
        uploadPrompt.classList.remove('hidden');
        fileSelected.classList.add('hidden');
        submitBtn.disabled = true;
    }

    dropZone.addEventListener('click', () => fileInput.click());

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('dragover');
    });

    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('dragover');
    });

    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            fileInput.files = files;
            showFileSelected(files[0]);
        }
    });

    fileInput.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            showFileSelected(e.target.files[0]);
        }
    });

    changeFileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        resetForm();
    });

    const modeOptions = document.querySelectorAll('.mode-option');
    function updateModeSelection() {
        modeOptions.forEach(option => {
            const input = option.querySelector('input[type="radio"]');
            const check = option.querySelector('.mode-check');
            if (input.checked) {
                option.classList.add('border-apc-red', 'bg-red-50');
                check.classList.remove('hidden');
            } else {
                option.classList.remove('border-apc-red', 'bg-red-50');
                check.classList.add('hidden');
            }
        });
    }
    
    modeOptions.forEach(option => {
        option.addEventListener('click', () => {
            option.querySelector('input[type="radio"]').checked = true;
            updateModeSelection();
        });
    });
    updateModeSelection();

    uploadForm.addEventListener('submit', function(e) {
        submitBtn.disabled = true;
        dropZone.style.display = 'none';
        processingSection.classList.remove('hidden');
        
        let progress = 0;
        const interval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 300);
        
        setTimeout(() => clearInterval(interval), 30000);
    });
});
</script>
{% endblock %}
