<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Revisión - Anonimizador Legal | APC Jurídica</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='anonymizer.css') }}">
</head>
<body>
  <header class="header">
    <div class="header-logo">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
        <path d="M2 17l10 5 10-5"/>
        <path d="M2 12l10 5 10-5"/>
      </svg>
    </div>
    <div>
      <div class="header-title">Revisión de entidades</div>
      <div class="header-subtitle">{{ original_filename }}</div>
    </div>
    <a href="/anonymizer" class="back-link-header">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
      Cancelar
    </a>
  </header>

  <main class="main-container">
    <div class="review-container">
      <div class="card preview-card">
        <div class="preview-header">
          <h2 class="preview-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
              <polyline points="14 2 14 8 20 8"/>
              <line x1="16" y1="13" x2="8" y2="13"/>
              <line x1="16" y1="17" x2="8" y2="17"/>
            </svg>
            Vista previa del documento
          </h2>
        </div>
        <div class="document-preview" id="documentText">{{ full_text }}</div>
        <p class="preview-hint">Selecciona texto para marcarlo manualmente como entidad</p>
      </div>

      <div class="card entities-card">
        <div class="entities-header">
          <h2 class="entities-title">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="9 11 12 14 22 4"/>
              <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/>
            </svg>
            Entidades detectadas
          </h2>
          <div class="entities-actions">
            <button type="button" id="selectAllBtn">Seleccionar todos</button>
            <button type="button" id="deselectAllBtn">Deseleccionar</button>
          </div>
        </div>

        <div class="entities-list" id="entitiesContainer">
          {% if confirmed_by_type %}
          <div class="entities-section">
            <div class="section-header section-confirmed">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
              </svg>
              Confirmadas ({{ confirmed_count }})
            </div>
            {% for type, entities in confirmed_by_type.items() %}
            <div class="entity-group">
              <div class="entity-group-title">
                <span class="type-badge type-{{ type }}">{{ type }}</span>
                <span class="entity-group-count">{{ entities|length }}</span>
              </div>
              {% for entity in entities %}
              <label class="entity-item entity-confirmed">
                <input type="checkbox" class="entity-checkbox" data-entity='{{ entity | tojson }}' checked>
                <span class="entity-value" title="{{ entity.value }}">{{ entity.value[:40] }}{% if entity.value|length > 40 %}...{% endif %}</span>
                <span class="entity-confidence confidence-high">{{ (entity.confidence * 100)|round|int }}%</span>
              </label>
              {% endfor %}
            </div>
            {% endfor %}
          </div>
          {% endif %}

          {% if needs_review_by_type %}
          <div class="entities-section">
            <div class="section-header section-review">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
              </svg>
              Requieren revisión ({{ needs_review_count }})
            </div>
            {% for type, entities in needs_review_by_type.items() %}
            <div class="entity-group">
              <div class="entity-group-title">
                <span class="type-badge type-{{ type }}">{{ type }}</span>
                <span class="entity-group-count">{{ entities|length }}</span>
              </div>
              {% for entity in entities %}
              <label class="entity-item entity-review">
                <input type="checkbox" class="entity-checkbox" data-entity='{{ entity | tojson }}'>
                <span class="entity-value" title="{{ entity.value }}">{{ entity.value[:40] }}{% if entity.value|length > 40 %}...{% endif %}</span>
                <span class="entity-confidence confidence-medium">{{ (entity.confidence * 100)|round|int }}%</span>
              </label>
              {% endfor %}
            </div>
            {% endfor %}
          </div>
          {% endif %}

          {% if not confirmed_by_type and not needs_review_by_type %}
          <div class="empty-state">
            <svg class="empty-state-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <circle cx="11" cy="11" r="8"/>
              <line x1="21" y1="21" x2="16.65" y2="16.65"/>
            </svg>
            <p>No se detectaron entidades automáticamente</p>
            <p style="font-size: 13px; margin-top: 4px;">Selecciona texto en el documento para marcarlo manualmente</p>
          </div>
          {% endif %}
        </div>

        <div id="manualSection" class="manual-section" style="display: none;">
          <div class="section-header section-manual">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
              <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
            </svg>
            Marcadas manualmente (<span id="manualCount">0</span>)
          </div>
          <div id="manualList" class="manual-list"></div>
        </div>

        <div class="selection-counter" id="selectionCount">
          Seleccionadas: <strong>0</strong> de 0
        </div>

        <form id="applyForm" action="/anonymizer/apply" method="POST">
          <input type="hidden" name="temp_input_path" value="{{ temp_input_path }}">
          <input type="hidden" name="ext" value="{{ ext }}">
          <input type="hidden" name="original_filename" value="{{ original_filename }}">
          <input type="hidden" name="selected_entities_json" id="selectedEntitiesJson" value="[]">

          <div class="review-footer">
            <button type="submit" id="applyBtn" class="btn btn-primary">
              <span id="applySpinner" class="spinner" style="display: none;"></span>
              <span id="applyText">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                  <polyline points="7 10 12 15 17 10"/>
                  <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                Aplicar anonimización
              </span>
            </button>
            <a href="/anonymizer" class="btn btn-secondary" id="cancelBtn">Cancelar</a>
          </div>
        </form>
      </div>
    </div>

    <div id="selectionToolbar" class="selection-toolbar" style="display: none;">
      <p class="toolbar-label">Marcar como:</p>
      <div class="toolbar-buttons">
        <button type="button" class="mark-type-btn type-badge type-PERSONA" data-type="PERSONA">PERSONA</button>
        <button type="button" class="mark-type-btn type-badge type-DNI" data-type="DNI">DNI</button>
        <button type="button" class="mark-type-btn type-badge type-RUC" data-type="RUC">RUC</button>
        <button type="button" class="mark-type-btn type-badge type-EMAIL" data-type="EMAIL">EMAIL</button>
        <button type="button" class="mark-type-btn type-badge type-TELEFONO" data-type="TELEFONO">TELEFONO</button>
        <button type="button" class="mark-type-btn type-badge type-DIRECCION" data-type="DIRECCION">DIRECCION</button>
        <button type="button" class="mark-type-btn type-badge type-EXPEDIENTE" data-type="EXPEDIENTE">EXPEDIENTE</button>
      </div>
    </div>
  </main>

  <div id="processingOverlay" class="processing-overlay">
    <div class="processing-modal">
      <div class="processing-spinner"></div>
      <div class="processing-text">Anonimizando documento...</div>
    </div>
  </div>

  <script>
  window.__ENTITIES__ = {{ entities_all | tojson }};
  </script>
  <script src="{{ url_for('static', filename='anonymizer.js') }}"></script>
</body>
</html>
