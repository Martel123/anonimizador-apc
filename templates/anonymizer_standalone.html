<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Anonimizador Legal | APC Jurídica</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'inter': ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            'apc': {
              'red': '#B30000',
              'red-dark': '#8B0000',
              'red-light': '#FEF2F2',
              'black': '#0B0B0B',
              'gray-bg': '#F5F5F5',
              'gray-text': '#6F6F6F',
              'gray-border': '#E5E5E5',
            }
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    
    .drop-zone {
      border: 2px dashed #D4A0A0;
      background-color: #FEF7F7;
      transition: all 0.2s ease;
    }
    .drop-zone:hover {
      border-color: #B30000;
      background-color: #FEF2F2;
    }
    .drop-zone.dragover {
      border-color: #B30000;
      background-color: #FEF2F2;
    }
    .drop-zone.has-file {
      border-color: #10B981;
      background-color: #ECFDF5;
    }
    
    .btn-primary {
      background-color: #F5F5F5;
      color: #9CA3AF;
      transition: all 0.2s ease;
    }
    .btn-primary.enabled {
      background-color: #B30000;
      color: white;
    }
    .btn-primary.enabled:hover {
      background-color: #8B0000;
    }
    
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 26px;
      background-color: #E5E5E5;
      border-radius: 9999px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .toggle-switch.active {
      background-color: #B30000;
    }
    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 20px;
      height: 20px;
      background-color: white;
      border-radius: 50%;
      transition: transform 0.2s;
    }
    .toggle-switch.active::after {
      transform: translateX(22px);
    }
    
    .progress-bar {
      height: 4px;
      background-color: #FEE2E2;
      border-radius: 2px;
      overflow: hidden;
    }
    .progress-bar-fill {
      height: 100%;
      background-color: #B30000;
      animation: progress 2s ease-in-out infinite;
    }
    @keyframes progress {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .spinner {
      animation: spin 1s linear infinite;
    }

    .feature-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      text-align: left;
    }
    .feature-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
  </style>
</head>
<body class="bg-apc-gray-bg min-h-screen flex flex-col">
  
  <!-- Header -->
  <header class="bg-apc-black">
    <div class="max-w-5xl mx-auto px-4 py-3">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-4">
          <img src="{{ url_for('static', filename='images/logo_apc_juridica.png') }}" alt="APC Jurídica" class="h-14 w-auto">
          <div>
            <h1 class="text-lg font-semibold text-white">Anonimizador de documentos legales</h1>
            <p class="text-xs text-gray-400">Elimina datos sensibles sin guardar información ni reescribir documentos</p>
          </div>
        </div>
        <div class="flex items-center space-x-2 text-sm text-gray-400">
          <i class="fas fa-lock text-apc-red"></i>
          <span class="hidden sm:inline">Procesamiento seguro</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 py-10 px-4">
    <div class="max-w-3xl mx-auto">
      
      <!-- Title Section -->
      <div class="text-center mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-3">Anonimiza tus documentos legales</h2>
        <p class="text-sm text-apc-gray-text max-w-xl mx-auto">
          Sube un documento DOCX o PDF y nuestro sistema identificará automáticamente datos personales usando IA y reglas especializadas para documentos legales peruanos.
        </p>
      </div>

      {% if error %}
      <div class="mb-6 p-4 rounded-xl bg-red-50 text-apc-red border border-red-200 text-sm max-w-lg mx-auto">
        <div class="flex items-center">
          <i class="fas fa-exclamation-circle mr-2"></i>
          {{ error }}
        </div>
      </div>
      {% endif %}

      {% if not openai_available %}
      <div class="mb-6 p-4 rounded-xl bg-red-50 text-apc-red border border-red-200 text-sm max-w-lg mx-auto">
        <div class="flex items-start">
          <i class="fas fa-exclamation-triangle mr-2 mt-0.5"></i>
          <div>
            <strong>Servicio no disponible</strong><br>
            <span class="text-xs">Contacte al administrador del sistema.</span>
          </div>
        </div>
      </div>
      {% endif %}

      <form id="uploadForm" action="/anonymizer/process" method="POST" enctype="multipart/form-data">
        
        <!-- Dropzone Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-apc-gray-border p-6 mb-4">
          
          <!-- Dropzone - Expanded -->
          <div id="dropzone" class="drop-zone rounded-xl py-16 px-8 text-center cursor-pointer mb-4">
            <div id="dropzoneDefault" class="flex flex-col items-center">
              <div class="w-20 h-20 rounded-full bg-apc-red-light flex items-center justify-center mb-5">
                <i class="fas fa-cloud-upload-alt text-4xl text-apc-red"></i>
              </div>
              <p class="text-lg font-medium text-gray-800 mb-2">Arrastra tu archivo aquí</p>
              <p class="text-sm text-apc-gray-text mb-5">o <span class="text-apc-red font-medium cursor-pointer hover:underline">haz clic para seleccionar</span></p>
              
              <!-- Format indicators -->
              <div class="flex items-center justify-center gap-8 mb-4">
                <div class="flex items-center gap-2 text-sm text-gray-600">
                  <i class="fas fa-file-word text-blue-600 text-lg"></i>
                  <span>DOCX</span>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-600">
                  <i class="fas fa-file-pdf text-red-600 text-lg"></i>
                  <span>PDF</span>
                </div>
                <div class="flex items-center gap-2 text-sm text-gray-600">
                  <i class="fas fa-file-alt text-gray-500 text-lg"></i>
                  <span>TXT</span>
                </div>
              </div>
              
              <p class="text-sm text-apc-gray-text">Máximo 10 MB</p>
            </div>
            
            <!-- File loaded state -->
            <div id="dropzoneFile" class="hidden">
              <div class="flex items-center justify-center space-x-3">
                <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center">
                  <i class="fas fa-check text-green-600 text-xl"></i>
                </div>
                <div class="text-left">
                  <p id="fileName" class="text-sm font-medium text-gray-800 truncate max-w-[250px]">documento.docx</p>
                  <p id="fileSize" class="text-xs text-apc-gray-text">1.2 MB</p>
                </div>
              </div>
              <button type="button" id="changeFileBtn" class="mt-4 text-sm text-apc-red font-medium hover:underline">
                <i class="fas fa-sync-alt mr-1"></i> Cambiar archivo
              </button>
            </div>
          </div>

          <input type="file" id="fileInput" name="file" accept=".docx,.pdf,.txt" class="hidden">
        </div>

        <!-- Options Card -->
        <div class="bg-white rounded-2xl shadow-sm border border-apc-gray-border p-6 mb-4">
          <div class="flex items-center gap-2 mb-4">
            <i class="fas fa-cog text-apc-gray-text"></i>
            <span class="font-medium text-gray-800">Opciones de anonimización</span>
          </div>
          
          <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-3">
              <div>
                <p class="text-sm font-medium text-gray-800">Modo estricto</p>
                <p class="text-xs text-apc-gray-text">Revisión manual de nombres dudosos</p>
              </div>
              <div id="toggleEstricto" class="toggle-switch active" data-option="strict"></div>
            </div>
            
            <div class="flex items-center gap-3">
              <div>
                <p class="text-sm font-medium text-gray-800">Diccionario CSV</p>
                <p class="text-xs text-apc-gray-text">Exportar tabla de mapeo</p>
              </div>
              <div id="toggleCSV" class="toggle-switch" data-option="csv"></div>
            </div>
          </div>
        </div>

        <!-- Hidden inputs for options -->
        <input type="hidden" name="strict_mode" id="strictModeInput" value="true">
        <input type="hidden" name="export_csv" id="exportCsvInput" value="false">

        <!-- Processing State -->
        <div id="processingState" class="hidden mb-4">
          <div class="bg-apc-red-light rounded-2xl border border-red-200 p-6 text-center">
            <div class="flex items-center justify-center gap-3 mb-3">
              <i class="fas fa-circle-notch spinner text-apc-red text-xl"></i>
              <span class="text-base font-medium text-gray-800">Procesando documento...</span>
            </div>
            <div class="progress-bar max-w-md mx-auto mb-3">
              <div class="progress-bar-fill"></div>
            </div>
            <p class="text-sm text-apc-red">Detectando datos personales con IA y reglas</p>
          </div>
        </div>

        <!-- Submit Button -->
        <button type="submit" id="submitBtn" class="btn-primary w-full py-4 rounded-2xl font-medium text-base flex items-center justify-center gap-2" disabled data-service-available="{{ 'true' if openai_available else 'false' }}">
          <i class="fas fa-shield-alt"></i>
          <span id="submitText">Analizar documento</span>
        </button>
      </form>

      <!-- Features Section -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-8">
        <div class="feature-card">
          <div class="feature-icon bg-red-50">
            <i class="fas fa-shield-alt text-apc-red text-lg"></i>
          </div>
          <h3 class="font-semibold text-gray-900 mb-2">Confidencial</h3>
          <p class="text-sm text-apc-gray-text">Los archivos se procesan en memoria y se eliminan inmediatamente.</p>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon bg-red-50">
            <i class="fas fa-user-check text-apc-red text-lg"></i>
          </div>
          <h3 class="font-semibold text-gray-900 mb-2">Revisión manual</h3>
          <p class="text-sm text-apc-gray-text">Revisa y selecciona qué datos tokenizar antes de aplicar.</p>
        </div>
        
        <div class="feature-card">
          <div class="feature-icon bg-red-50">
            <i class="fas fa-code text-apc-red text-lg"></i>
          </div>
          <h3 class="font-semibold text-gray-900 mb-2">Tokens claros</h3>
          <p class="text-sm text-apc-gray-text">Reemplazo con tokens como {{PERSONA_1}}, para trazabilidad.</p>
        </div>
      </div>

      <!-- Tipos de datos detectados Section -->
      <div class="bg-white rounded-2xl shadow-sm border border-apc-gray-border p-6 mt-6">
        <div class="flex items-center gap-2 mb-4">
          <i class="fas fa-tags text-apc-gray-text"></i>
          <span class="font-medium text-gray-800">Tipos de datos detectados</span>
        </div>
        <div class="flex flex-wrap gap-3">
          <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-red-500 text-white">DNI</span>
            <span class="text-sm text-gray-600">8 dígitos</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-orange-500 text-white">RUC</span>
            <span class="text-sm text-gray-600">11 dígitos</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-blue-500 text-white">EMAIL</span>
            <span class="text-sm text-gray-600">Correos</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-cyan-500 text-white">TEL</span>
            <span class="text-sm text-gray-600">Teléfonos</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-purple-500 text-white">PERSONA</span>
            <span class="text-sm text-gray-600">Nombres</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-pink-500 text-white">DIR</span>
            <span class="text-sm text-gray-600">Direcciones</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-amber-500 text-white">EXP</span>
            <span class="text-sm text-gray-600">Expedientes</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-indigo-500 text-white">CAS</span>
            <span class="text-sm text-gray-600">Casillas</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-slate-500 text-white">JUZ</span>
            <span class="text-sm text-gray-600">Juzgados</span>
          </div>
          <div class="flex items-center gap-2 bg-gray-50 rounded-lg px-3 py-2">
            <span class="inline-block px-2 py-0.5 rounded text-xs font-semibold bg-yellow-500 text-white">CUENTA</span>
            <span class="text-sm text-gray-600">Bancarias</span>
          </div>
        </div>
      </div>

    </div>
  </main>

  <script>
  document.addEventListener('DOMContentLoaded', function() {
    const dropzone = document.getElementById('dropzone');
    const dropzoneDefault = document.getElementById('dropzoneDefault');
    const dropzoneFile = document.getElementById('dropzoneFile');
    const fileInput = document.getElementById('fileInput');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const changeFileBtn = document.getElementById('changeFileBtn');
    const submitBtn = document.getElementById('submitBtn');
    const uploadForm = document.getElementById('uploadForm');
    const processingState = document.getElementById('processingState');
    const toggleEstricto = document.getElementById('toggleEstricto');
    const toggleCSV = document.getElementById('toggleCSV');
    const strictModeInput = document.getElementById('strictModeInput');
    const exportCsvInput = document.getElementById('exportCsvInput');
    
    const allowedExtensions = ['docx', 'pdf', 'txt'];
    const maxSize = 10 * 1024 * 1024;
    const serviceAvailable = submitBtn.dataset.serviceAvailable === 'true';

    // Toggle switches
    toggleEstricto.addEventListener('click', function() {
      this.classList.toggle('active');
      strictModeInput.value = this.classList.contains('active') ? 'true' : 'false';
    });

    toggleCSV.addEventListener('click', function() {
      this.classList.toggle('active');
      exportCsvInput.value = this.classList.contains('active') ? 'true' : 'false';
    });

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function showFileState(file) {
      dropzone.classList.add('has-file');
      dropzoneDefault.classList.add('hidden');
      dropzoneFile.classList.remove('hidden');
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);
      if (serviceAvailable) {
        submitBtn.disabled = false;
        submitBtn.classList.add('enabled');
      }
    }

    function resetFileState() {
      dropzone.classList.remove('has-file');
      dropzoneDefault.classList.remove('hidden');
      dropzoneFile.classList.add('hidden');
      fileInput.value = '';
      submitBtn.disabled = true;
      submitBtn.classList.remove('enabled');
    }

    function handleFile(file) {
      const ext = file.name.split('.').pop().toLowerCase();
      
      if (!allowedExtensions.includes(ext)) {
        alert('Formato no soportado. Use archivos DOCX o PDF.');
        return;
      }
      if (file.size > maxSize) {
        alert('El archivo excede el tamaño máximo de 10 MB.');
        return;
      }

      const dt = new DataTransfer();
      dt.items.add(file);
      fileInput.files = dt.files;
      
      showFileState(file);
    }

    // Click to select
    dropzone.addEventListener('click', function(e) {
      if (e.target === changeFileBtn || changeFileBtn.contains(e.target)) return;
      fileInput.click();
    });

    // File input change
    fileInput.addEventListener('change', function() {
      if (fileInput.files.length > 0) {
        handleFile(fileInput.files[0]);
      }
    });

    // Change file button
    changeFileBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      fileInput.click();
    });

    // Drag and drop
    ['dragenter', 'dragover'].forEach(eventName => {
      dropzone.addEventListener(eventName, function(e) {
        e.preventDefault();
        e.stopPropagation();
        if (!dropzone.classList.contains('has-file')) {
          dropzone.classList.add('dragover');
        }
      });
    });

    ['dragleave', 'drop'].forEach(eventName => {
      dropzone.addEventListener(eventName, function(e) {
        e.preventDefault();
        e.stopPropagation();
        dropzone.classList.remove('dragover');
      });
    });

    dropzone.addEventListener('drop', function(e) {
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    // Form submit with processing state
    uploadForm.addEventListener('submit', function(e) {
      if (!fileInput.files.length) {
        e.preventDefault();
        alert('Por favor seleccione un archivo');
        return;
      }

      // Show processing state
      submitBtn.disabled = true;
      submitBtn.classList.remove('enabled');
      processingState.classList.remove('hidden');

      // Simulate minimum 900ms processing time
      e.preventDefault();
      setTimeout(function() {
        uploadForm.submit();
      }, 900);
    });
  });
  </script>
</body>
</html>
