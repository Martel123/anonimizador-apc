{% extends "base_dashboard.html" %}

{% block title %}Buscar Documentos Similares{% endblock %}
{% block page_title %}Buscar Documentos Similares{% endblock %}
{% block page_subtitle %}Encuentra documentos parecidos para guiarte{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="p-6 border-b border-gray-200 bg-gradient-to-r from-blue-50 to-indigo-50">
            <div class="flex items-center space-x-4">
                <div class="p-3 bg-blue-100 rounded-lg">
                    <i class="fas fa-robot text-blue-600 text-2xl"></i>
                </div>
                <div>
                    <h3 class="text-lg font-medium text-gray-900">Asistente de Busqueda</h3>
                    <p class="text-sm text-gray-600">Preguntame por documentos similares. Por ejemplo: "Muestrame casos de divorcio" o "Busco demandas de alimentos"</p>
                </div>
            </div>
        </div>

        <div id="chat-container" class="h-96 overflow-y-auto p-6 space-y-4 bg-gray-50">
            <div class="flex items-start space-x-3">
                <div class="p-2 bg-blue-100 rounded-full">
                    <i class="fas fa-robot text-blue-600 text-sm"></i>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 max-w-lg">
                    <p class="text-gray-700">Hola, soy tu asistente de busqueda. Puedo ayudarte a encontrar documentos similares a los que necesitas. Â¿Que tipo de documento estas buscando?</p>
                </div>
            </div>
        </div>

        <div class="p-4 border-t border-gray-200 bg-white">
            <form id="search-form" class="flex space-x-3">
                <input type="text" id="consulta" name="consulta" 
                       placeholder="Escribe tu consulta... Ej: Muestrame casos parecidos a demandas de alimentos"
                       class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                       autocomplete="off">
                <button type="submit" id="btn-buscar" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition-colors flex items-center">
                    <i class="fas fa-search mr-2"></i>Buscar
                </button>
            </form>
        </div>
    </div>

    <div id="documentos-encontrados" class="mt-6 hidden">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="p-4 border-b border-gray-200 bg-green-50">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="fas fa-file-alt text-green-600 mr-2"></i>Documentos Encontrados
                </h3>
            </div>
            <div id="lista-documentos" class="divide-y divide-gray-100">
            </div>
        </div>
    </div>
</div>

<script>
document.getElementById('search-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const consulta = document.getElementById('consulta').value.trim();
    if (!consulta) return;
    
    const chatContainer = document.getElementById('chat-container');
    const btnBuscar = document.getElementById('btn-buscar');
    
    // Agregar mensaje del usuario
    chatContainer.innerHTML += `
        <div class="flex items-start space-x-3 justify-end">
            <div class="bg-blue-600 text-white rounded-lg p-4 shadow-sm max-w-lg">
                <p>${consulta}</p>
            </div>
            <div class="p-2 bg-gray-200 rounded-full">
                <i class="fas fa-user text-gray-600 text-sm"></i>
            </div>
        </div>
    `;
    
    // Mostrar indicador de carga
    const loadingId = 'loading-' + Date.now();
    chatContainer.innerHTML += `
        <div id="${loadingId}" class="flex items-start space-x-3">
            <div class="p-2 bg-blue-100 rounded-full">
                <i class="fas fa-robot text-blue-600 text-sm"></i>
            </div>
            <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                <div class="flex items-center space-x-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600"></div>
                    <span class="text-gray-500">Buscando...</span>
                </div>
            </div>
        </div>
    `;
    
    chatContainer.scrollTop = chatContainer.scrollHeight;
    btnBuscar.disabled = true;
    document.getElementById('consulta').value = '';
    
    try {
        const formData = new FormData();
        formData.append('consulta', consulta);
        
        const response = await fetch('{{ url_for("buscar_similares_consultar") }}', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        // Remover indicador de carga
        document.getElementById(loadingId).remove();
        
        // Agregar respuesta del asistente
        chatContainer.innerHTML += `
            <div class="flex items-start space-x-3">
                <div class="p-2 bg-blue-100 rounded-full">
                    <i class="fas fa-robot text-blue-600 text-sm"></i>
                </div>
                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200 max-w-lg">
                    <p class="text-gray-700">${data.respuesta}</p>
                </div>
            </div>
        `;
        
        // Mostrar documentos encontrados
        const docsContainer = document.getElementById('documentos-encontrados');
        const listaDocumentos = document.getElementById('lista-documentos');
        
        if (data.documentos && data.documentos.length > 0) {
            docsContainer.classList.remove('hidden');
            listaDocumentos.innerHTML = '';
            
            data.documentos.forEach(doc => {
                listaDocumentos.innerHTML += `
                    <div class="p-4 hover:bg-gray-50 transition-colors">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-file-word text-blue-500 text-lg"></i>
                                <div>
                                    <p class="font-medium text-gray-900">${doc.nombre}</p>
                                    <p class="text-sm text-gray-500">
                                        ${doc.tipo} ${doc.numero_expediente ? '| Exp: ' + doc.numero_expediente : ''} | ${doc.fecha}
                                    </p>
                                </div>
                            </div>
                            ${doc.tiene_archivo ? `
                                <a href="/descargar-terminado/${doc.id}" class="px-3 py-1 bg-blue-100 text-blue-700 rounded-lg text-sm hover:bg-blue-200 transition-colors">
                                    <i class="fas fa-download mr-1"></i>Descargar
                                </a>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
        } else {
            docsContainer.classList.add('hidden');
        }
        
    } catch (error) {
        document.getElementById(loadingId).remove();
        chatContainer.innerHTML += `
            <div class="flex items-start space-x-3">
                <div class="p-2 bg-red-100 rounded-full">
                    <i class="fas fa-robot text-red-600 text-sm"></i>
                </div>
                <div class="bg-red-50 rounded-lg p-4 shadow-sm border border-red-200 max-w-lg">
                    <p class="text-red-700">Hubo un error al procesar tu consulta. Por favor intenta de nuevo.</p>
                </div>
            </div>
        `;
    }
    
    btnBuscar.disabled = false;
    chatContainer.scrollTop = chatContainer.scrollHeight;
});
</script>
{% endblock %}
