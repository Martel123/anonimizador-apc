{% extends "base_dashboard.html" %}

{% block title %}{% if caso %}Editar Caso{% else %}Nuevo Caso{% endif %}{% endblock %}
{% block page_title %}{% if caso %}Editar Caso{% else %}Nuevo Caso{% endif %}{% endblock %}
{% block page_subtitle %}{% if caso %}Modifica la información del caso{% else %}Registra un nuevo caso o expediente{% endif %}{% endblock %}

{% block content %}
<div class="max-w-4xl">
    <form method="post" enctype="multipart/form-data" class="space-y-6">
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-info-circle text-blue-500 mr-2"></i>Información General
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Título del Caso *</label>
                    <input type="text" name="titulo" value="{{ caso.titulo if caso else '' }}" required
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Ej: Demanda de alimentos - García vs. López">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">N° Expediente</label>
                    <input type="text" name="numero_expediente" value="{{ caso.numero_expediente if caso else '' }}"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Ej: 00123-2024-0-1801-JR-FC-01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Caso</label>
                    {% if tipos_caso %}
                    <select name="case_type_id" id="case-type-select" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Seleccionar tipo...</option>
                        {% for tipo in tipos_caso %}
                        <option value="{{ tipo.id }}" data-icon="{{ tipo.icono }}" data-color="{{ tipo.color }}"
                                {% if caso and caso.case_type_id == tipo.id %}selected{% endif %}>
                            {{ tipo.nombre }}
                        </option>
                        {% endfor %}
                        <option value="otro">Otro (escribir)</option>
                    </select>
                    <input type="text" name="tipo_caso" id="tipo-caso-manual" value="{{ caso.tipo_caso if caso and not caso.case_type_id else '' }}"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent mt-2 hidden"
                           placeholder="Ej: Derecho de Familia">
                    {% else %}
                    <input type="text" name="tipo_caso" value="{{ caso.tipo_caso if caso else '' }}"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Ej: Derecho de Familia">
                    {% endif %}
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Estado</label>
                    <select name="estado" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                        {% for key, label in estados.items() %}
                        <option value="{{ key }}" {% if (caso and caso.estado == key) or (not caso and key == 'por_comenzar') %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Prioridad</label>
                    <select name="prioridad" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                        {% for key, label in prioridades.items() %}
                        <option value="{{ key }}" {% if (caso and caso.prioridad == key) or (not caso and key == 'media') %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Juzgado</label>
                    <input type="text" name="juzgado" value="{{ caso.juzgado if caso else '' }}"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Ej: 1° Juzgado de Familia de Lima">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Límite</label>
                    <input type="date" name="fecha_limite" value="{{ caso.fecha_limite.strftime('%Y-%m-%d') if caso and caso.fecha_limite else '' }}"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <textarea name="descripcion" rows="3"
                              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Descripción breve del caso...">{{ caso.descripcion if caso else '' }}</textarea>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-user text-green-500 mr-2"></i>Cliente
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente *</label>
                    <input type="text" name="cliente_nombre" value="{{ caso.cliente_nombre if caso else '' }}" required
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Nombre completo">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" name="cliente_email" value="{{ caso.cliente_email if caso else '' }}"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="cliente@email.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Teléfono</label>
                    <input type="tel" name="cliente_telefono" value="{{ caso.cliente_telefono if caso else '' }}"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="+51 999 999 999">
                </div>
            </div>
        </div>

        {% if campos_generales or tipos_caso %}
        <div class="bg-white rounded-xl shadow-sm p-6" id="campos-personalizados-section">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-th-list text-indigo-500 mr-2"></i>Campos Adicionales
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="campos-container">
                {% for campo in campos_generales %}
                <div class="campo-general">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        {{ campo.label }}{% if campo.requerido %} *{% endif %}
                    </label>
                    {% if campo.tipo == 'textarea' %}
                    <textarea name="custom_{{ campo.nombre }}" rows="3" 
                              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500"
                              {% if campo.requerido %}required{% endif %}
                              placeholder="{{ campo.placeholder or '' }}"></textarea>
                    {% elif campo.tipo == 'select' %}
                    <select name="custom_{{ campo.nombre }}" 
                            class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500"
                            {% if campo.requerido %}required{% endif %}>
                        <option value="">Seleccionar...</option>
                        {% for opcion in campo.get_opciones_list() %}
                        <option value="{{ opcion }}">{{ opcion }}</option>
                        {% endfor %}
                    </select>
                    {% elif campo.tipo == 'checkbox' %}
                    <label class="flex items-center">
                        <input type="checkbox" name="custom_{{ campo.nombre }}" value="si" class="rounded text-blue-600 mr-2">
                        <span class="text-sm text-gray-700">{{ campo.placeholder or 'Si' }}</span>
                    </label>
                    {% elif campo.tipo == 'date' %}
                    <input type="date" name="custom_{{ campo.nombre }}"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500"
                           {% if campo.requerido %}required{% endif %}>
                    {% elif campo.tipo == 'number' or campo.tipo == 'currency' %}
                    <input type="number" name="custom_{{ campo.nombre }}" step="0.01"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500"
                           {% if campo.requerido %}required{% endif %}
                           placeholder="{{ campo.placeholder or '' }}">
                    {% else %}
                    <input type="{{ campo.tipo }}" name="custom_{{ campo.nombre }}"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500"
                           {% if campo.requerido %}required{% endif %}
                           placeholder="{{ campo.placeholder or '' }}">
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            <div id="campos-tipo-especifico" class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"></div>
        </div>
        {% endif %}

        {% if not caso %}
        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-users text-purple-500 mr-2"></i>Asignación de Equipo
            </h3>
            <p class="text-sm text-gray-500 mb-4">Selecciona los colaboradores que trabajarán en este caso. Solo ellos podrán ver y gestionar el caso.</p>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Agregar Colaborador</label>
                    <div class="flex gap-2">
                        <select id="colaborador-select" class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Buscar colaborador...</option>
                            {% for usuario in usuarios %}
                            <option value="{{ usuario.id }}" data-name="{{ usuario.username }}" data-email="{{ usuario.email }}">{{ usuario.username }} ({{ usuario.email }})</option>
                            {% endfor %}
                        </select>
                        <button type="button" id="add-colaborador-btn" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
                <div id="colaboradores-list" class="space-y-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Responsable Principal (opcional)</label>
                    <select name="responsable_id" id="responsable-select" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">Sin responsable principal</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">El responsable principal será marcado con una estrella en el equipo.</p>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-paperclip text-orange-500 mr-2"></i>Archivos Adjuntos
            </h3>
            <p class="text-sm text-gray-500 mb-3">Puedes adjuntar documentos relacionados al caso (PDF, Word, imágenes, etc.)</p>
            <div id="archivos-list" class="space-y-2 mb-4"></div>
            <div class="flex items-center gap-2">
                <input type="file" id="archivo-input" multiple accept=".pdf,.doc,.docx,.png,.jpg,.jpeg,.gif,.xls,.xlsx,.txt"
                       class="flex-1 px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                <button type="button" id="add-archivo-btn" class="px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-1"></i> Agregar
                </button>
            </div>
            <div id="archivos-container"></div>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-sticky-note text-yellow-500 mr-2"></i>Notas Adicionales
            </h3>
            <textarea name="notas" rows="4"
                      class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                      placeholder="Notas internas sobre el caso...">{{ caso.notas if caso else '' }}</textarea>
        </div>

        <div class="flex items-center justify-between">
            <a href="{{ url_for('casos') if not caso else url_for('caso_detalle', caso_id=caso.id) }}" 
               class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> Cancelar
            </a>
            <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                <i class="fas fa-save mr-2"></i> {% if caso %}Guardar Cambios{% else %}Crear Caso{% endif %}
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const archivoInput = document.getElementById('archivo-input');
    const addArchivoBtn = document.getElementById('add-archivo-btn');
    const archivosList = document.getElementById('archivos-list');
    const archivosContainer = document.getElementById('archivos-container');
    let fileCounter = 0;

    if (addArchivoBtn) {
        addArchivoBtn.addEventListener('click', function() {
            const files = archivoInput.files;
            if (!files.length) return;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                fileCounter++;
                const fileId = 'file_' + fileCounter;

                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
                item.dataset.fileId = fileId;
                item.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i class="fas fa-file text-gray-400"></i>
                        <span class="text-sm text-gray-700">${file.name}</span>
                        <span class="text-xs text-gray-400">(${(file.size / 1024).toFixed(1)} KB)</span>
                    </div>
                    <button type="button" class="remove-archivo text-red-400 hover:text-red-600">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                archivosList.appendChild(item);

                const hiddenInput = document.createElement('input');
                hiddenInput.type = 'file';
                hiddenInput.name = 'archivos';
                hiddenInput.style.display = 'none';
                hiddenInput.dataset.fileId = fileId;

                const dt = new DataTransfer();
                dt.items.add(file);
                hiddenInput.files = dt.files;
                archivosContainer.appendChild(hiddenInput);
            }
            archivoInput.value = '';
        });

        archivosList.addEventListener('click', function(e) {
            if (e.target.closest('.remove-archivo')) {
                const item = e.target.closest('[data-file-id]');
                const fileId = item.dataset.fileId;
                item.remove();
                const hiddenInput = archivosContainer.querySelector(`input[data-file-id="${fileId}"]`);
                if (hiddenInput) hiddenInput.remove();
            }
        });
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const caseTypeSelect = document.getElementById('case-type-select');
    const tipoCasoManual = document.getElementById('tipo-caso-manual');
    const camposTipoEspecifico = document.getElementById('campos-tipo-especifico');
    
    if (caseTypeSelect) {
        caseTypeSelect.addEventListener('change', function() {
            const typeId = this.value;
            
            if (typeId === 'otro') {
                tipoCasoManual.classList.remove('hidden');
                tipoCasoManual.focus();
                camposTipoEspecifico.innerHTML = '';
            } else {
                tipoCasoManual.classList.add('hidden');
                tipoCasoManual.value = '';
                
                if (typeId) {
                    fetch(`/api/admin/tipos-caso/${typeId}/campos`)
                        .then(r => r.json())
                        .then(data => {
                            camposTipoEspecifico.innerHTML = '';
                            data.campos.forEach(campo => {
                                const div = document.createElement('div');
                                div.className = 'campo-tipo-especifico';
                                
                                let inputHtml = '';
                                const req = campo.requerido ? 'required' : '';
                                const placeholder = campo.placeholder || '';
                                
                                if (campo.tipo === 'textarea') {
                                    inputHtml = `<textarea name="custom_${campo.nombre}" rows="3" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" ${req} placeholder="${placeholder}"></textarea>`;
                                } else if (campo.tipo === 'select') {
                                    const opts = campo.opciones ? campo.opciones.split(',').map(o => `<option value="${o.trim()}">${o.trim()}</option>`).join('') : '';
                                    inputHtml = `<select name="custom_${campo.nombre}" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" ${req}><option value="">Seleccionar...</option>${opts}</select>`;
                                } else if (campo.tipo === 'checkbox') {
                                    inputHtml = `<label class="flex items-center"><input type="checkbox" name="custom_${campo.nombre}" value="si" class="rounded text-blue-600 mr-2"><span class="text-sm text-gray-700">${placeholder || 'Si'}</span></label>`;
                                } else if (campo.tipo === 'date') {
                                    inputHtml = `<input type="date" name="custom_${campo.nombre}" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" ${req}>`;
                                } else if (campo.tipo === 'number' || campo.tipo === 'currency') {
                                    inputHtml = `<input type="number" name="custom_${campo.nombre}" step="0.01" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" ${req} placeholder="${placeholder}">`;
                                } else {
                                    inputHtml = `<input type="${campo.tipo}" name="custom_${campo.nombre}" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500" ${req} placeholder="${placeholder}">`;
                                }
                                
                                div.innerHTML = `
                                    <label class="block text-sm font-medium text-gray-700 mb-1">
                                        ${campo.label}${campo.requerido ? ' *' : ''}
                                    </label>
                                    ${inputHtml}
                                `;
                                camposTipoEspecifico.appendChild(div);
                            });
                        });
                } else {
                    camposTipoEspecifico.innerHTML = '';
                }
            }
        });
    }
});
</script>
{% if not caso %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const colaboradorSelect = document.getElementById('colaborador-select');
    const addBtn = document.getElementById('add-colaborador-btn');
    const colaboradoresList = document.getElementById('colaboradores-list');
    const responsableSelect = document.getElementById('responsable-select');
    const addedColaboradores = new Set();

    function updateResponsableOptions() {
        const currentValue = responsableSelect.value;
        responsableSelect.innerHTML = '<option value="">Sin responsable principal</option>';
        addedColaboradores.forEach(id => {
            const option = colaboradorSelect.querySelector(`option[value="${id}"]`);
            if (option) {
                const newOpt = document.createElement('option');
                newOpt.value = id;
                newOpt.textContent = option.dataset.name + ' (' + option.dataset.email + ')';
                responsableSelect.appendChild(newOpt);
            }
        });
        if (addedColaboradores.has(currentValue)) {
            responsableSelect.value = currentValue;
        }
    }

    function addColaborador() {
        const selectedOption = colaboradorSelect.options[colaboradorSelect.selectedIndex];
        if (!selectedOption.value || addedColaboradores.has(selectedOption.value)) return;

        const id = selectedOption.value;
        const name = selectedOption.dataset.name;
        const email = selectedOption.dataset.email;

        addedColaboradores.add(id);

        const item = document.createElement('div');
        item.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg';
        item.dataset.id = id;
        item.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="h-8 w-8 bg-blue-500 rounded-full flex items-center justify-center text-white text-sm font-medium">
                    ${name[0].toUpperCase()}
                </div>
                <div>
                    <p class="font-medium text-sm">${name}</p>
                    <p class="text-xs text-gray-500">${email}</p>
                </div>
            </div>
            <input type="hidden" name="colaboradores" value="${id}">
            <button type="button" class="remove-colaborador text-red-400 hover:text-red-600">
                <i class="fas fa-times"></i>
            </button>
        `;
        colaboradoresList.appendChild(item);
        colaboradorSelect.value = '';
        updateResponsableOptions();
    }

    addBtn.addEventListener('click', addColaborador);

    colaboradoresList.addEventListener('click', function(e) {
        if (e.target.closest('.remove-colaborador')) {
            const item = e.target.closest('[data-id]');
            addedColaboradores.delete(item.dataset.id);
            item.remove();
            updateResponsableOptions();
        }
    });
});
</script>
{% endif %}
{% endblock %}
