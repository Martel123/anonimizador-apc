{% extends "base_dashboard.html" %}

{% block title %}Apariencia del Estudio{% endblock %}

{% block page_title %}Apariencia del Estudio{% endblock %}
{% block page_subtitle %}Personaliza los colores y branding de tu estudio{% endblock %}

{% block content %}
<div class="max-w-4xl">
    <form method="POST" enctype="multipart/form-data" class="space-y-8">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-image mr-2 text-blue-600"></i>
                    Branding
                </h3>
                <p class="text-sm text-gray-500 mt-1">Logo del estudio para encabezados de documentos</p>
            </div>
            <div class="p-6">
                <div class="flex items-start space-x-6">
                    <div class="flex-shrink-0">
                        <div id="logo-preview" class="w-32 h-32 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center overflow-hidden bg-gray-50">
                            {% if tenant.logo_path %}
                                <img src="{{ url_for('static', filename='tenants/' + tenant.slug + '/' + tenant.logo_path) }}" alt="Logo actual" class="w-full h-full object-contain">
                            {% else %}
                                <div class="text-center text-gray-400">
                                    <i class="fas fa-image text-3xl mb-2"></i>
                                    <p class="text-xs">Sin logo</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Logo del Estudio</label>
                        <input type="file" name="logo" id="logo-input" accept="image/*"
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-medium file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 cursor-pointer">
                        <p class="mt-2 text-xs text-gray-500">Formatos: PNG, JPG, SVG. Maximo 2MB. Recomendado: 200x200px</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-palette mr-2 text-blue-600"></i>
                    Colores del Estudio
                </h3>
                <p class="text-sm text-gray-500 mt-1">Estos colores se aplicaran en botones, links y elementos destacados</p>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Color Primario
                            <span class="text-gray-400 font-normal">(botones, links, highlights)</span>
                        </label>
                        <div class="flex items-center space-x-3">
                            <input type="color" name="color_primario" id="color_primario" 
                                   value="{{ tenant.color_primario or '#3B82F6' }}"
                                   class="h-12 w-20 rounded cursor-pointer border border-gray-300">
                            <input type="text" id="color_primario_text" 
                                   value="{{ tenant.color_primario or '#3B82F6' }}"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono uppercase"
                                   pattern="^#[0-9A-Fa-f]{6}$" maxlength="7">
                        </div>
                        <div class="mt-3">
                            <span class="text-xs text-gray-500">Vista previa:</span>
                            <button type="button" id="preview-primary" class="ml-2 px-4 py-2 text-white text-sm rounded-lg transition-colors" style="background-color: {{ tenant.color_primario or '#3B82F6' }}">
                                Boton Ejemplo
                            </button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Color Secundario
                            <span class="text-gray-400 font-normal">(badges, estados, indicadores)</span>
                        </label>
                        <div class="flex items-center space-x-3">
                            <input type="color" name="color_secundario" id="color_secundario" 
                                   value="{{ tenant.color_secundario or '#10B981' }}"
                                   class="h-12 w-20 rounded cursor-pointer border border-gray-300">
                            <input type="text" id="color_secundario_text" 
                                   value="{{ tenant.color_secundario or '#10B981' }}"
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm font-mono uppercase"
                                   pattern="^#[0-9A-Fa-f]{6}$" maxlength="7">
                        </div>
                        <div class="mt-3">
                            <span class="text-xs text-gray-500">Vista previa:</span>
                            <span id="preview-secondary" class="ml-2 px-3 py-1 text-white text-xs rounded-full" style="background-color: {{ tenant.color_secundario or '#10B981' }}">
                                Estado Activo
                            </span>
                        </div>
                    </div>
                </div>
                <div id="contrast-warning" class="hidden mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="text-sm text-yellow-800">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        <span id="contrast-message">El color seleccionado puede tener bajo contraste con el texto blanco.</span>
                    </p>
                </div>
            </div>
        </div>

        <div class="flex justify-end space-x-4">
            <a href="{{ url_for('admin') }}" class="px-6 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                Cancelar
            </a>
            <button type="submit" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                <i class="fas fa-save mr-2"></i>
                Guardar Cambios
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const colorPrimario = document.getElementById('color_primario');
    const colorPrimarioText = document.getElementById('color_primario_text');
    const colorSecundario = document.getElementById('color_secundario');
    const colorSecundarioText = document.getElementById('color_secundario_text');
    const previewPrimary = document.getElementById('preview-primary');
    const previewSecondary = document.getElementById('preview-secondary');
    const contrastWarning = document.getElementById('contrast-warning');
    const contrastMessage = document.getElementById('contrast-message');
    const logoInput = document.getElementById('logo-input');
    const logoPreview = document.getElementById('logo-preview');

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }

    function getLuminance(r, g, b) {
        const [rs, gs, bs] = [r, g, b].map(c => {
            c = c / 255;
            return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
        });
        return 0.2126 * rs + 0.7152 * gs + 0.0722 * bs;
    }

    function checkContrast(hex) {
        const rgb = hexToRgb(hex);
        if (!rgb) return true;
        const luminance = getLuminance(rgb.r, rgb.g, rgb.b);
        const whiteLuminance = 1;
        const ratio = (whiteLuminance + 0.05) / (luminance + 0.05);
        return ratio >= 4.5;
    }

    function updateColor(colorInput, textInput, preview, isPrimary) {
        const color = colorInput.value.toUpperCase();
        textInput.value = color;
        preview.style.backgroundColor = color;
        
        if (!checkContrast(color)) {
            contrastWarning.classList.remove('hidden');
            contrastMessage.textContent = `El color ${isPrimary ? 'primario' : 'secundario'} (${color}) puede tener bajo contraste con el texto blanco.`;
        } else {
            contrastWarning.classList.add('hidden');
        }
    }

    colorPrimario.addEventListener('input', () => updateColor(colorPrimario, colorPrimarioText, previewPrimary, true));
    colorSecundario.addEventListener('input', () => updateColor(colorSecundario, colorSecundarioText, previewSecondary, false));

    colorPrimarioText.addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
            colorPrimario.value = this.value;
            previewPrimary.style.backgroundColor = this.value;
        }
    });

    colorSecundarioText.addEventListener('input', function() {
        if (/^#[0-9A-Fa-f]{6}$/.test(this.value)) {
            colorSecundario.value = this.value;
            previewSecondary.style.backgroundColor = this.value;
        }
    });

    logoInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                logoPreview.innerHTML = `<img src="${e.target.result}" alt="Preview" class="w-full h-full object-contain">`;
            };
            reader.readAsDataURL(this.files[0]);
        }
    });
});
</script>
{% endblock %}
