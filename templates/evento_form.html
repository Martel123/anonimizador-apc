{% extends "base_dashboard.html" %}

{% block title %}{% if evento %}Editar Evento{% else %}Nuevo Evento{% endif %}{% endblock %}
{% block page_title %}{% if evento %}Editar Evento{% else %}Nuevo Evento{% endif %}{% endblock %}
{% block page_subtitle %}{% if evento %}Modifica la información del evento{% else %}Crea un nuevo evento en el calendario{% endif %}{% endblock %}

{% block extra_head %}
<style>
    .color-option {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid transparent;
        transition: all 0.2s;
    }
    .color-option:hover {
        transform: scale(1.1);
    }
    .color-option.selected {
        border-color: #1f2937;
        box-shadow: 0 0 0 2px white, 0 0 0 4px currentColor;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-2xl">
    <form method="post" class="space-y-6">
        <div class="bg-white rounded-xl shadow-sm p-6">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Título *</label>
                    <input type="text" name="titulo" value="{{ evento.titulo if evento else '' }}" required
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Ej: Reunión con cliente">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                    <textarea name="descripcion" rows="3"
                              class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                              placeholder="Descripción detallada del evento...">{{ evento.descripcion if evento else '' }}</textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo de Evento</label>
                        <select name="tipo" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                            {% for key, label in tipos.items() %}
                            <option value="{{ key }}" {% if evento and evento.tipo == key %}selected{% endif %}>{{ label }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Caso Relacionado</label>
                        <select name="case_id" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Sin caso asociado</option>
                            {% for caso in cases %}
                            <option value="{{ caso.id }}" {% if evento and evento.case_id == caso.id %}selected{% endif %}>
                                {{ caso.titulo[:50] }}{% if caso.titulo|length > 50 %}...{% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>

                <div>
                    <label class="flex items-center gap-2 text-sm font-medium text-gray-700 cursor-pointer">
                        <input type="checkbox" name="todo_el_dia" id="todo_el_dia" 
                               {% if evento and evento.todo_el_dia %}checked{% endif %}
                               class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                        <span>Todo el día</span>
                    </label>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Inicio *</label>
                        <input type="date" name="fecha_inicio" required
                               value="{{ evento.fecha_inicio.strftime('%Y-%m-%d') if evento else fecha_preseleccionada }}"
                               class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div id="hora_inicio_container">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hora de Inicio</label>
                        <input type="time" name="hora_inicio" 
                               value="{{ evento.fecha_inicio.strftime('%H:%M') if evento and not evento.todo_el_dia else '09:00' }}"
                               class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha de Fin</label>
                        <input type="date" name="fecha_fin" 
                               value="{{ evento.fecha_fin.strftime('%Y-%m-%d') if evento and evento.fecha_fin else '' }}"
                               class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div id="hora_fin_container">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Hora de Fin</label>
                        <input type="time" name="hora_fin" 
                               value="{{ evento.fecha_fin.strftime('%H:%M') if evento and evento.fecha_fin and not evento.todo_el_dia else '10:00' }}"
                               class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-map-marker-alt text-red-500 mr-1"></i>Ubicación
                    </label>
                    <input type="text" name="ubicacion" value="{{ evento.ubicacion if evento else '' }}"
                           class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                           placeholder="Ej: Sala de reuniones, Juzgado, Zoom...">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Color del Evento</label>
                    <div class="flex gap-3 flex-wrap">
                        {% set colores = ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16'] %}
                        {% for color in colores %}
                        <label class="color-option {% if (evento and evento.color == color) or (not evento and color == '#3b82f6') %}selected{% endif %}"
                               style="background-color: {{ color }}; color: {{ color }};">
                            <input type="radio" name="color" value="{{ color }}" class="hidden"
                                   {% if (evento and evento.color == color) or (not evento and color == '#3b82f6') %}checked{% endif %}>
                        </label>
                        {% endfor %}
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-bell text-yellow-500 mr-1"></i>Recordatorio
                    </label>
                    <select name="recordatorio_minutos" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="0" {% if evento and evento.recordatorio_minutos == 0 %}selected{% endif %}>Sin recordatorio</option>
                        <option value="15" {% if evento and evento.recordatorio_minutos == 15 %}selected{% endif %}>15 minutos antes</option>
                        <option value="30" {% if (not evento) or (evento and evento.recordatorio_minutos == 30) %}selected{% endif %}>30 minutos antes</option>
                        <option value="60" {% if evento and evento.recordatorio_minutos == 60 %}selected{% endif %}>1 hora antes</option>
                        <option value="1440" {% if evento and evento.recordatorio_minutos == 1440 %}selected{% endif %}>1 día antes</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-users text-blue-500 mr-1"></i>Invitados
                    </label>
                    <div class="border border-gray-200 rounded-lg p-3 max-h-48 overflow-y-auto">
                        {% for usuario in usuarios %}
                        {% if usuario.id != current_user.id %}
                        <label class="flex items-center gap-3 py-2 px-2 hover:bg-gray-50 rounded cursor-pointer">
                            <input type="checkbox" name="invitados" value="{{ usuario.id }}"
                                   {% if invitados_actuales is defined and usuario.id in invitados_actuales %}checked{% endif %}
                                   class="w-4 h-4 text-blue-600 rounded focus:ring-blue-500">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-sm font-medium text-gray-600">
                                    {{ usuario.username[0]|upper }}
                                </div>
                                <span class="text-sm text-gray-700">{{ usuario.username }}</span>
                            </div>
                        </label>
                        {% endif %}
                        {% endfor %}
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Selecciona los miembros del equipo que deseas invitar</p>
                </div>
            </div>
        </div>

        <div class="flex items-center justify-between">
            <a href="{{ url_for('calendario') }}" class="px-6 py-2 text-gray-600 hover:text-gray-800 font-medium transition-colors">
                <i class="fas fa-arrow-left mr-2"></i> Cancelar
            </a>
            <button type="submit" class="px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium transition-colors">
                <i class="fas fa-save mr-2"></i> {% if evento %}Guardar Cambios{% else %}Crear Evento{% endif %}
            </button>
        </div>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const todoElDia = document.getElementById('todo_el_dia');
    const horaInicioContainer = document.getElementById('hora_inicio_container');
    const horaFinContainer = document.getElementById('hora_fin_container');
    
    function toggleHoras() {
        if (todoElDia.checked) {
            horaInicioContainer.style.display = 'none';
            horaFinContainer.style.display = 'none';
        } else {
            horaInicioContainer.style.display = 'block';
            horaFinContainer.style.display = 'block';
        }
    }
    
    todoElDia.addEventListener('change', toggleHoras);
    toggleHoras();
    
    const colorOptions = document.querySelectorAll('.color-option');
    colorOptions.forEach(option => {
        option.addEventListener('click', function() {
            colorOptions.forEach(o => o.classList.remove('selected'));
            this.classList.add('selected');
            this.querySelector('input').checked = true;
        });
    });
});
</script>
{% endblock %}
