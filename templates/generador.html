{% extends "base_dashboard.html" %}

{% block title %}Generador de Documentos{% endblock %}
{% block page_title %}Generador de Documentos{% endblock %}
{% block page_subtitle %}Complete el formulario para generar su documento legal{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg shadow-md p-6 md:p-8 mb-8 border border-purple-200">
        <h3 class="text-xl font-medium text-gray-900 mb-4">
            <i class="fas fa-qrcode text-purple-600 mr-2"></i>Cargar desde Formulario
        </h3>
        <p class="text-sm text-gray-600 mb-4">Ingrese el código del formulario para auto-completar los campos con la información del cliente.</p>
        <div class="flex flex-col sm:flex-row gap-3">
            <div class="flex-1">
                <input type="text" id="codigo_formulario" 
                       placeholder="Ej: APC-EA-AB12CD"
                       class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 uppercase"
                       style="text-transform: uppercase;">
            </div>
            <button type="button" onclick="cargarFormulario()" id="btnCargarFormulario"
                    class="h-12 px-6 bg-purple-600 hover:bg-purple-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 flex items-center justify-center">
                <span id="btnCargarText"><i class="fas fa-search mr-2"></i>Cargar Datos</span>
                <span id="btnCargarLoading" class="hidden">
                    <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </span>
            </button>
        </div>
        <div id="formularioInfo" class="hidden mt-4 p-4 bg-white rounded-lg border border-green-300">
            <div class="flex items-center justify-between">
                <div>
                    <span class="text-sm font-medium text-green-700"><i class="fas fa-check-circle mr-1"></i>Formulario encontrado:</span>
                    <span id="formularioCode" class="ml-2 font-mono text-green-800"></span>
                </div>
                <span id="formularioStatus" class="px-2 py-1 text-xs rounded-full"></span>
            </div>
            <p class="text-sm text-gray-600 mt-2">Tipo de documento: <span id="formularioModelo" class="font-medium text-gray-800"></span></p>
            <p class="text-sm text-gray-500 mt-1">Fecha: <span id="formularioFecha"></span></p>
            <div class="mt-4 flex gap-3">
                <button type="button" onclick="confirmarYCargarCampos()" id="btnConfirmar"
                        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white font-medium rounded-lg transition flex items-center gap-2">
                    <i class="fas fa-check"></i> Confirmar y Rellenar Campos
                </button>
                <button type="button" onclick="cancelarFormulario()"
                        class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg transition">
                    Cancelar
                </button>
            </div>
        </div>
        <div id="formularioCargado" class="hidden mt-4 p-4 bg-green-50 rounded-lg border border-green-400">
            <div class="flex items-center gap-2 text-green-700">
                <i class="fas fa-check-circle text-lg"></i>
                <span class="font-medium">Campos rellenados con datos del formulario</span>
                <span id="formularioCodeCargado" class="font-mono ml-2"></span>
            </div>
        </div>
        <div id="formularioError" class="hidden mt-4 p-3 bg-red-50 text-red-700 rounded-lg border border-red-200">
            <i class="fas fa-exclamation-circle mr-1"></i><span id="formularioErrorMsg"></span>
        </div>
        <input type="hidden" name="form_response_id" id="form_response_id" value="">
    </div>

    <form id="documentForm" action="{{ url_for('procesar_ia') }}" method="POST" class="space-y-8">
        <div class="bg-white rounded-lg shadow-md p-6 md:p-8">
            <h3 class="text-xl font-medium text-gray-900 mb-6">Tipo de Documento</h3>
            <div>
                <label for="tipo_documento" class="block text-sm font-medium text-gray-700 mb-2">
                    Seleccione el tipo de documento *
                </label>
                <select name="tipo_documento" id="tipo_documento" required onchange="cargarCampos()"
                    class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 text-gray-900 bg-white">
                    <option value="">-- Seleccione una opción --</option>
                    {% for key, modelo in modelos.items() %}
                        <option value="{{ key }}">{{ modelo.nombre }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div id="camposDinamicos" class="hidden">
            <div class="bg-white rounded-lg shadow-md p-6 md:p-8">
                <h3 class="text-xl font-medium text-gray-900 mb-6">Datos del Caso</h3>
                <div id="camposContainer" class="grid gap-6">
                </div>
            </div>
        </div>

        <div id="camposEstaticos">
            <div class="bg-white rounded-lg shadow-md p-6 md:p-8">
                <h3 class="text-xl font-medium text-gray-900 mb-6">Información Personal</h3>
                <div class="grid gap-6">
                    <div>
                        <label for="invitado" class="block text-sm font-medium text-gray-700 mb-2">
                            Invitado
                        </label>
                        <input type="text" name="invitado" id="invitado"
                            placeholder="Nombre del invitado"
                            class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                    </div>
                    <div>
                        <label for="demandante1" class="block text-sm font-medium text-gray-700 mb-2">
                            Demandante *
                        </label>
                        <input type="text" name="demandante1" id="demandante1"
                            placeholder="Nombre completo del demandante"
                            class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                    </div>
                    <div>
                        <label for="dni_demandante1" class="block text-sm font-medium text-gray-700 mb-2">
                            DNI del Demandante *
                        </label>
                        <input type="text" name="dni_demandante1" id="dni_demandante1"
                            placeholder="Número de documento de identidad"
                            class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mt-8">
                <h3 class="text-xl font-medium text-gray-900 mb-6">Argumentos del Caso</h3>
                <div class="grid gap-6">
                    <div>
                        <label for="argumento1" class="block text-sm font-medium text-gray-700 mb-2">
                            Argumento 1 *
                        </label>
                        <textarea name="argumento1" id="argumento1"
                            rows="4"
                            placeholder="Describa el primer argumento del caso..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-y min-h-32"></textarea>
                    </div>
                    <div>
                        <label for="argumento2" class="block text-sm font-medium text-gray-700 mb-2">
                            Argumento 2
                        </label>
                        <textarea name="argumento2" id="argumento2"
                            rows="4"
                            placeholder="Describa el segundo argumento del caso..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-y min-h-32"></textarea>
                    </div>
                    <div>
                        <label for="argumento3" class="block text-sm font-medium text-gray-700 mb-2">
                            Argumento 3
                        </label>
                        <textarea name="argumento3" id="argumento3"
                            rows="4"
                            placeholder="Describa el tercer argumento del caso..."
                            class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-y min-h-32"></textarea>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6 md:p-8 mt-8">
                <h3 class="text-xl font-medium text-gray-900 mb-6">Conclusión</h3>
                <div>
                    <label for="conclusion" class="block text-sm font-medium text-gray-700 mb-2">
                        Conclusión del Caso *
                    </label>
                    <textarea name="conclusion" id="conclusion"
                        rows="4"
                        placeholder="Describa la conclusión o petitorio del caso..."
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-y min-h-32"></textarea>
                </div>
            </div>
        </div>

        <div class="flex flex-col md:flex-row gap-4 justify-center">
            <button type="button" id="previewBtn" onclick="submitForPreview()"
                class="h-12 px-8 bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                <span id="previewBtnText">Ver Preview</span>
                <span id="previewBtnLoading" class="hidden">
                    <svg class="animate-spin inline-block w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generando...
                </span>
            </button>
            <button type="submit" id="submitBtn"
                class="h-12 px-8 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg shadow-md hover:shadow-lg transition-all duration-200 focus:ring-4 focus:ring-blue-200">
                <span id="btnText">Generar y Descargar</span>
                <span id="btnLoading" class="hidden">
                    <svg class="animate-spin inline-block w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    Generando...
                </span>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    let camposCache = {};
    let formularioCargado = null;

    function cargarFormulario() {
        const code = document.getElementById('codigo_formulario').value.trim().toUpperCase();
        if (!code) {
            mostrarError('Por favor ingrese un código de formulario.');
            return;
        }

        document.getElementById('btnCargarText').classList.add('hidden');
        document.getElementById('btnCargarLoading').classList.remove('hidden');
        document.getElementById('btnCargarFormulario').disabled = true;

        fetch('/api/formulario/buscar/' + encodeURIComponent(code))
            .then(response => response.json())
            .then(data => {
                document.getElementById('btnCargarText').classList.remove('hidden');
                document.getElementById('btnCargarLoading').classList.add('hidden');
                document.getElementById('btnCargarFormulario').disabled = false;

                if (data.error) {
                    mostrarError(data.error);
                    return;
                }

                formularioCargado = data;
                document.getElementById('form_response_id').value = data.form_id;

                document.getElementById('formularioInfo').classList.remove('hidden');
                document.getElementById('formularioCargado').classList.add('hidden');
                document.getElementById('formularioError').classList.add('hidden');
                document.getElementById('formularioCode').textContent = data.code;
                document.getElementById('formularioModelo').textContent = data.template_name;
                document.getElementById('formularioFecha').textContent = data.created_at || '';

                const statusEl = document.getElementById('formularioStatus');
                if (data.can_use) {
                    statusEl.textContent = data.status_label;
                    statusEl.className = 'px-2 py-1 text-xs rounded-full bg-green-100 text-green-800';
                } else {
                    statusEl.textContent = data.status_label + ' (No disponible)';
                    statusEl.className = 'px-2 py-1 text-xs rounded-full bg-red-100 text-red-800';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('btnCargarText').classList.remove('hidden');
                document.getElementById('btnCargarLoading').classList.add('hidden');
                document.getElementById('btnCargarFormulario').disabled = false;
                mostrarError('Error al buscar el formulario. Intente nuevamente.');
            });
    }

    function mostrarError(mensaje) {
        document.getElementById('formularioInfo').classList.add('hidden');
        document.getElementById('formularioCargado').classList.add('hidden');
        document.getElementById('formularioError').classList.remove('hidden');
        document.getElementById('formularioErrorMsg').textContent = mensaje;
    }

    function confirmarYCargarCampos() {
        if (!formularioCargado) return;

        const data = formularioCargado;
        const tipoDocSelect = document.getElementById('tipo_documento');
        
        for (let i = 0; i < tipoDocSelect.options.length; i++) {
            if (tipoDocSelect.options[i].value === data.template_key) {
                tipoDocSelect.selectedIndex = i;
                break;
            }
        }

        cargarCampos().then(() => {
            setTimeout(() => {
                llenarCamposConRespuestas(data.answers);
                document.getElementById('formularioInfo').classList.add('hidden');
                document.getElementById('formularioCargado').classList.remove('hidden');
                document.getElementById('formularioCodeCargado').textContent = data.code;
            }, 300);
        });
    }

    function cancelarFormulario() {
        formularioCargado = null;
        document.getElementById('form_response_id').value = '';
        document.getElementById('formularioInfo').classList.add('hidden');
        document.getElementById('formularioCargado').classList.add('hidden');
        document.getElementById('codigo_formulario').value = '';
    }

    function llenarCamposConRespuestas(answers) {
        if (!answers) return;

        for (const [campo, valor] of Object.entries(answers)) {
            const input = document.querySelector(`[name="${campo}"], [name="campo_${campo}"]`);
            if (input) {
                input.value = valor;
                input.classList.add('bg-purple-50', 'border-purple-300');
            }
        }
    }

    document.getElementById('codigo_formulario').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            cargarFormulario();
        }
    });

    function cargarCampos() {
        const tipoDoc = document.getElementById('tipo_documento').value;
        const camposDinamicos = document.getElementById('camposDinamicos');
        const camposEstaticos = document.getElementById('camposEstaticos');
        const camposContainer = document.getElementById('camposContainer');
        
        if (!tipoDoc) {
            camposDinamicos.classList.add('hidden');
            camposEstaticos.classList.remove('hidden');
            return Promise.resolve();
        }

        if (camposCache[tipoDoc] !== undefined) {
            renderizarCampos(camposCache[tipoDoc]);
            return Promise.resolve();
        }

        return fetch('/api/campos/' + tipoDoc)
            .then(response => response.json())
            .then(data => {
                const campos = data.campos || data || [];
                camposCache[tipoDoc] = campos;
                renderizarCampos(campos);
            })
            .catch(error => {
                console.error('Error cargando campos:', error);
                camposDinamicos.classList.add('hidden');
                camposEstaticos.classList.remove('hidden');
            });
    }

    function renderizarCampos(campos) {
        const camposDinamicos = document.getElementById('camposDinamicos');
        const camposEstaticos = document.getElementById('camposEstaticos');
        const camposContainer = document.getElementById('camposContainer');

        if (campos.length === 0) {
            camposDinamicos.classList.add('hidden');
            camposEstaticos.classList.remove('hidden');
            return;
        }

        camposEstaticos.classList.add('hidden');
        camposDinamicos.classList.remove('hidden');
        camposContainer.innerHTML = '';

        campos.forEach(campo => {
            const div = document.createElement('div');
            const requiredAttr = campo.requerido ? 'required' : '';
            const requiredMark = campo.requerido ? ' *' : '';
            
            let inputHtml = '';
            
            switch(campo.tipo) {
                case 'textarea':
                    inputHtml = `<textarea name="${campo.nombre_campo}" id="${campo.nombre_campo}" ${requiredAttr}
                        rows="4" placeholder="${campo.placeholder || ''}"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200 resize-y min-h-32"></textarea>`;
                    break;
                case 'select':
                    let optionsHtml = '<option value="">-- Seleccione --</option>';
                    if (campo.opciones) {
                        campo.opciones.forEach(opt => {
                            optionsHtml += `<option value="${opt.trim()}">${opt.trim()}</option>`;
                        });
                    }
                    inputHtml = `<select name="${campo.nombre_campo}" id="${campo.nombre_campo}" ${requiredAttr}
                        class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">${optionsHtml}</select>`;
                    break;
                case 'date':
                    inputHtml = `<input type="date" name="${campo.nombre_campo}" id="${campo.nombre_campo}" ${requiredAttr}
                        class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">`;
                    break;
                case 'number':
                    inputHtml = `<input type="number" name="${campo.nombre_campo}" id="${campo.nombre_campo}" ${requiredAttr}
                        placeholder="${campo.placeholder || ''}"
                        class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">`;
                    break;
                case 'email':
                    inputHtml = `<input type="email" name="${campo.nombre_campo}" id="${campo.nombre_campo}" ${requiredAttr}
                        placeholder="${campo.placeholder || ''}"
                        class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">`;
                    break;
                default:
                    inputHtml = `<input type="text" name="${campo.nombre_campo}" id="${campo.nombre_campo}" ${requiredAttr}
                        placeholder="${campo.placeholder || ''}"
                        class="w-full h-12 px-4 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200">`;
            }
            
            div.innerHTML = `
                <label for="${campo.nombre_campo}" class="block text-sm font-medium text-gray-700 mb-2">
                    ${campo.etiqueta}${requiredMark}
                </label>
                ${inputHtml}
            `;
            camposContainer.appendChild(div);
        });
    }

    function submitForPreview() {
        document.getElementById('previewBtnText').classList.add('hidden');
        document.getElementById('previewBtnLoading').classList.remove('hidden');
        document.getElementById('previewBtn').disabled = true;
        document.getElementById('documentForm').action = '{{ url_for("preview") }}';
        document.getElementById('documentForm').submit();
    }

    document.getElementById('documentForm').addEventListener('submit', function(e) {
        if (this.action.includes('procesar_ia')) {
            document.getElementById('btnText').classList.add('hidden');
            document.getElementById('btnLoading').classList.remove('hidden');
            document.getElementById('submitBtn').disabled = true;
        }
    });
</script>
{% endblock %}
